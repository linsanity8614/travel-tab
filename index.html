<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TravelTab æ—…è²»é€š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F5F5F2; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-zoom-in { animation: zoomIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* éŠ€æ¡†è³ªæ„Ÿ */
        .silver-frame {
            border: 4px solid #E5E5E0;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            box-shadow: 
                0 10px 30px -5px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
        }

        /* ç´”æ·¨ Modal é¢¨æ ¼ */
        .clean-modal {
            background: #FFFFFF;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* Emoji Icon */
        .emoji-icon {
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ç®­é ­ (Chrome, Safari, Edge, Opera) */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ç®­é ­ (Firefox) */
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        import { 
            Plus, Users, ArrowRight, Trash2, PieChart, List, DollarSign, Activity, Calendar, 
            ArrowLeft, Settings, Share2, Edit2, Check, X, Image as ImageIcon, Camera, RefreshCw,
            Crown, Upload, Info, Link as LinkIcon, AlertTriangle, UserCheck, Utensils, Bus, Bed, Ticket, ShoppingBag, Box,
            Coffee, Beer, Music, Map, RotateCcw, UserPlus, Globe, FileText, AlertCircle
        } from 'https://esm.sh/lucide-react@0.263.1';
        import { PieChart as RePieChart, Pie, Cell, ResponsiveContainer, Tooltip as ReTooltip, Legend } from 'https://esm.sh/recharts@2.7.2?deps=react@18.2.0,react-dom@18.2.0';

        // ------------------------------------------------------------------
        // 1. Supabase è¨­å®š
        // ------------------------------------------------------------------
        const SUPABASE_URL = 'https://yefoncvvbkrbonqvunzg.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_YfssF9q0n5qo436Aut4CmA_zyVhtRkx'; 

        let supabase = null;
        if (SUPABASE_URL && SUPABASE_KEY) {
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        }

        // ------------------------------------------------------------------
        // 2. è¨­å®šèˆ‡è³‡æ–™
        // ------------------------------------------------------------------
        const COLORS = { 
            primary: '#6B8E78',      
            primaryDark: '#4A6756',  
            bg: '#F5F5F2',           
            text: '#4A4A4A',         
            danger: '#EF4444',       
            accent: '#E0A986'        
        };

        // Emoji é¢¨æ ¼åˆ†é¡
        const CATEGORIES = [
            { id: 'food', name: 'é£²é£Ÿ', color: '#E0A986', emoji: 'ğŸœ' },       
            { id: 'transport', name: 'äº¤é€š', color: '#8FB9A8', emoji: 'ğŸšŒ' },  
            { id: 'accommodation', name: 'ä½å®¿', color: '#A69CAC', emoji: 'ğŸ›ï¸' }, 
            { id: 'ticket', name: 'ç¥¨åˆ¸', color: '#F2CF59', emoji: 'ğŸ«' },     
            { id: 'shopping', name: 'è³¼ç‰©', color: '#88B0C9', emoji: 'ğŸ›ï¸' },
            { id: 'drink', name: 'é£²æ–™', color: '#C8A2C8', emoji: 'ğŸ¥¤' },   
            { id: 'entertainment', name: 'å¨›æ¨‚', color: '#FFB7B2', emoji: 'ğŸ¤' },
            { id: 'other', name: 'å…¶ä»–', color: '#B5B5B5', emoji: 'ğŸ“¦' },      
        ];

        const COMMON_CURRENCIES = ['TWD', 'JPY', 'KRW', 'USD', 'EUR', 'THB'];
        const DEFAULT_RATES = { 'TWD': 1, 'JPY': 0.22, 'KRW': 0.024, 'USD': 32.5, 'EUR': 35, 'THB': 0.9 };
        const CURRENCY_SYMBOLS = { 'TWD': 'NT$', 'JPY': 'Â¥', 'KRW': 'â‚©', 'USD': '$', 'EUR': 'â‚¬', 'THB': 'à¸¿' };

        const DEFAULT_IMG = 'https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800&q=80';
        const EMPTY_IMG = 'https://cdn-icons-png.flaticon.com/512/7486/7486744.png'; 

        const KEYWORD_IMAGES = {
          'æ—¥æœ¬': 'https://images.unsplash.com/photo-1542051841857-5f90071e7989?w=800&q=80',
          'æ±äº¬': 'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=800&q=80',
          'äº¬éƒ½': 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=800&q=80',
          'éŸ“åœ‹': 'https://images.unsplash.com/photo-1538485399081-7191377e8241?w=800&q=80',
          'é¦–çˆ¾': 'https://images.unsplash.com/photo-1538485399081-7191377e8241?w=800&q=80',
          'æ³°åœ‹': 'https://images.unsplash.com/photo-1552465011-b4e21bf6e79a?w=800&q=80',
          'æ›¼è°·': 'https://images.unsplash.com/photo-1508009603885-50cf7c579365?w=800&q=80',
          'æ­æ´²': 'https://images.unsplash.com/photo-1473625247510-8ceb1760943f?w=800&q=80'
        };

        const getKeywordImage = (name) => {
            if (!name) return null;
            for (const [key, url] of Object.entries(KEYWORD_IMAGES)) {
                if (name.includes(key)) return url;
            }
            return null;
        };

        const formatMoney = (v) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(v);
        const formatDate = (d) => new Date(d).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });

        const compressImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const max = 1000; 
                    if(w > h && w > max) { h *= max/w; w = max; } else if(h > max) { w *= max/h; h = max; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(resolve, 'image/jpeg', 0.8);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // ------------------------------------------------------------------
        // 3. ä¸»æ‡‰ç”¨ç¨‹å¼
        // ------------------------------------------------------------------
        function App() {
            const [view, setView] = useState('list'); 
            const [projects, setProjects] = useState([]);
            const [curProject, setCurProject] = useState(null);
            const [tempProject, setTempProject] = useState(null); 
            const [userId] = useState(() => localStorage.getItem('user_id') || crypto.randomUUID());
            const [toast, setToast] = useState(null);
            const [showMemberSelect, setShowMemberSelect] = useState(false);

            useEffect(() => {
                localStorage.setItem('user_id', userId);
                if (!supabase) return;

                const fetchProjects = async () => {
                    const { data } = await supabase.from('projects').select('*').order('created_at', { ascending: false });
                    setProjects(data || []);
                };
                fetchProjects();

                const sub = supabase.channel('projects').on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, fetchProjects).subscribe();
                return () => supabase.removeChannel(sub);
            }, []);

            const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };

            const handleProjectClick = (project) => {
                const storedMemberId = localStorage.getItem(`member_${project.id}`);
                if (storedMemberId && project.members.find(m => m.id === storedMemberId)) {
                    setCurProject(project);
                    setView('dashboard');
                } else {
                    setTempProject(project);
                    setShowMemberSelect(true);
                }
            };

            const handleIdentityConfirm = (memberId) => {
                localStorage.setItem(`member_${tempProject.id}`, memberId);
                setCurProject(tempProject);
                setTempProject(null);
                setShowMemberSelect(false);
                setView('dashboard');
            };

            const handleJoinNewMember = async (name) => {
                if (!tempProject) return;
                const newMember = { id: crypto.randomUUID(), name };
                const updatedMembers = [...tempProject.members, newMember];
                
                const { error } = await supabase.from('projects')
                    .update({ members: updatedMembers })
                    .eq('id', tempProject.id);
                
                if (error) {
                    alert('åŠ å…¥å¤±æ•—: ' + error.message);
                } else {
                    localStorage.setItem(`member_${tempProject.id}`, newMember.id);
                    const updatedProject = { ...tempProject, members: updatedMembers };
                    setCurProject(updatedProject);
                    setTempProject(null);
                    setShowMemberSelect(false);
                    setView('dashboard');
                    showToast(`æ­¡è¿åŠ å…¥ï¼Œ${name}ï¼`);
                }
            };

            if (!supabase) return React.createElement(ConfigScreen);

            return React.createElement('div', { className: "min-h-screen pb-safe transition-colors duration-300", style: { backgroundColor: COLORS.bg } },
                view === 'list' 
                ? React.createElement(ProjectList, { 
                    projects, 
                    onCreate: async (name, members, bg) => {
                        const mObjs = members.map(m => ({ id: crypto.randomUUID(), name: m }));
                        const { error } = await supabase.from('projects').insert([{ name, members: mObjs, background_image: bg, created_by: userId }]);
                        if(error) alert(error.message); else showToast("è¡Œç¨‹å»ºç«‹æˆåŠŸ");
                    }, 
                    onSelect: handleProjectClick,
                    onDelete: async (id) => {
                         const { error } = await supabase.from('projects').delete().eq('id', id);
                         if(!error) showToast("è¡Œç¨‹å·²åˆªé™¤");
                    },
                    onUpdate: async (id, name, bg) => {
                         const { error } = await supabase.from('projects').update({ name, background_image: bg }).eq('id', id);
                         if(!error) showToast("æ›´æ–°æˆåŠŸ");
                    },
                    supabase 
                  })
                : React.createElement(Dashboard, { 
                    project: curProject, 
                    userId, 
                    onBack: () => setView('list'), 
                    showToast,
                    onUpdateProject: async (updates) => {
                        await supabase.from('projects').update(updates).eq('id', curProject.id);
                        setCurProject(prev => ({ ...prev, ...updates }));
                        showToast("è¨­å®šå·²æ›´æ–°");
                    },
                    supabase
                  }),
                
                showMemberSelect && tempProject && React.createElement(MemberSelectModal, {
                    project: tempProject,
                    onClose: () => { setShowMemberSelect(false); setTempProject(null); },
                    onConfirm: handleIdentityConfirm,
                    onJoinNew: handleJoinNewMember
                }),

                toast && React.createElement('div', { className: "fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl z-[100] flex items-center gap-2 animate-fade-in" }, 
                    React.createElement(Check, { size: 18, className: "text-green-400" }), toast
                )
            );
        }

        function ConfigScreen() {
            return React.createElement('div', { className: "h-screen flex items-center justify-center text-center p-6" }, "è«‹è¨­å®š Supabase");
        }

        // --- 1. å°ˆæ¡ˆåˆ—è¡¨ ---
        function ProjectList({ projects, onCreate, onSelect, onDelete, onUpdate, supabase }) {
            const [modalMode, setModalMode] = useState(null); 
            const [targetProject, setTargetProject] = useState(null);
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);

            return React.createElement('div', { className: "p-4 md:p-8 max-w-6xl mx-auto min-h-screen flex flex-col pt-12" },
                React.createElement('div', { className: "silver-frame rounded-[2.5rem] p-6 md:p-10 shadow-2xl relative min-h-[600px]" },
                    React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-center mb-8 gap-4 px-2" },
                        React.createElement('div', { className: "text-center md:text-left" },
                            React.createElement('h1', { className: "text-3xl font-bold flex items-center justify-center md:justify-start gap-3 text-stone-700 tracking-tight" }, 
                                React.createElement(Activity, { className: "stroke-2 text-[#6B8E78]" }), "TravelTab"
                            ),
                            React.createElement('p', { className: "text-stone-500 text-sm mt-1 font-medium tracking-wide" }, "å‡ºåœ‹åˆ†å¸³å°å¹«æ‰‹")
                        ),
                        React.createElement('button', { 
                            onClick: () => { setTargetProject(null); setModalMode('create'); },
                            className: "px-6 py-3 bg-[#6B8E78] text-white rounded-2xl shadow-lg hover:bg-[#5A7A66] transition-all flex items-center gap-2 font-bold"
                        }, React.createElement(Plus, { size: 20 }), "æ–°å¢è¡Œç¨‹")
                    ),
                    React.createElement('div', { className: "rounded-2xl p-4 md:p-8 bg-[#EBF0ED] min-h-[400px] border border-stone-200/30" },
                        projects.length === 0 
                        ? React.createElement('div', { className: "flex flex-col items-center justify-center h-full py-24 opacity-40" }, 
                            React.createElement(Calendar, { size: 64, className: "mx-auto mb-4 text-[#6B8E78]" }),
                            React.createElement('p', { className: "text-stone-500 font-medium" }, "é‚„æ²’æœ‰è¡Œç¨‹ï¼ŒæŒ‰å³ä¸Šæ–¹æ–°å¢")
                          )
                        : React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" }, 
                            projects.map(p => {
                                let bg = p.background_image || DEFAULT_IMG;
                                if (bg === DEFAULT_IMG || !bg) {
                                    const match = getKeywordImage(p.name);
                                    if(match) bg = match;
                                }
                                const organizer = p.members?.[0]?.name || 'ä¸»è¾¦äºº';
                                return React.createElement('div', { 
                                    key: p.id, 
                                    onClick: () => onSelect(p), 
                                    className: "relative w-full h-64 rounded-3xl overflow-hidden shadow-md cursor-pointer group hover:shadow-xl transition-all duration-300",
                                },
                                    React.createElement('div', { className: "absolute inset-0 bg-cover bg-center", style: { backgroundImage: `url(${bg})` } }),
                                    React.createElement('div', { className: "absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent transition-all duration-500 group-hover:from-black/90 group-hover:via-black/50 group-hover:to-black/30" }),
                                    React.createElement('div', { className: "absolute inset-0 p-6 flex flex-col justify-between z-10" },
                                        React.createElement('div', { className: "flex justify-between items-start" },
                                            React.createElement('div', { className: "bg-black/20 backdrop-blur-md px-3 py-1 rounded-full border border-white/20 group-hover:bg-black/40 transition-colors" },
                                                React.createElement('span', { className: "text-xs text-white/90 font-medium" }, formatDate(p.created_at))
                                            ),
                                            React.createElement('div', { className: "flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity" },
                                                React.createElement('button', { onClick: (e) => { e.stopPropagation(); setTargetProject(p); setModalMode('edit'); }, className: "p-2 bg-white/20 rounded-full hover:bg-white/40 text-white backdrop-blur-md" }, React.createElement(Edit2, { size: 18 })),
                                                React.createElement('button', { onClick: (e) => { e.stopPropagation(); setDeleteConfirmId(p.id); }, className: "p-2 bg-white/20 rounded-full hover:bg-red-500/80 text-white backdrop-blur-md" }, React.createElement(Trash2, { size: 18 }))
                                            )
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('h3', { className: "text-white font-bold text-2xl mb-3 drop-shadow-md leading-tight truncate transition-colors" }, p.name),
                                            React.createElement('div', { className: "flex items-center justify-between" },
                                                React.createElement('div', { className: "flex items-center gap-3 text-xs font-bold text-stone-100 bg-black/30 backdrop-blur-md px-4 py-2 rounded-xl border border-white/20 shadow-sm group-hover:bg-black/50 transition-colors" },
                                                    React.createElement('span', { className: "flex items-center gap-1.5" }, React.createElement(Crown, { size: 14, className: "text-yellow-300 fill-yellow-300" }), `ä¸»è¾¦äººï¼š${organizer}`),
                                                    React.createElement('span', { className: "w-px h-3 bg-white/40" }),
                                                    React.createElement('span', { className: "flex items-center gap-1.5" }, React.createElement(Users, { size: 14, className: "text-stone-200" }), `${p.members?.length || 0} äºº`)
                                                ),
                                                React.createElement('div', { className: "bg-white/20 p-2 rounded-full backdrop-blur-sm group-hover:bg-[#6B8E78] transition-colors" }, React.createElement(ArrowRight, { className: "text-white", size: 20 }))
                                            )
                                        )
                                    )
                                );
                            })
                          )
                    )
                ),
                modalMode && React.createElement(ProjectModal, { mode: modalMode, project: targetProject, onClose: () => setModalMode(null), onSubmit: modalMode === 'create' ? onCreate : (n, m, b) => onUpdate(targetProject.id, n, b), supabase }),
                deleteConfirmId && React.createElement(ConfirmModal, { title: "ç¢ºèªåˆªé™¤", message: "ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ", onClose: () => setDeleteConfirmId(null), onConfirm: () => { onDelete(deleteConfirmId); setDeleteConfirmId(null); } })
            );
        }

        // --- 2. èº«åˆ†é¸æ“‡è¦–çª— ---
        function MemberSelectModal({ project, onClose, onConfirm, onJoinNew }) {
            const [isJoining, setIsJoining] = useState(false);
            const [newName, setNewName] = useState('');

            return React.createElement('div', { 
                onClick: onClose, 
                className: "fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 animate-fade-in" 
            },
                React.createElement('div', { 
                    onClick: e => e.stopPropagation(), 
                    className: "clean-modal w-full max-w-sm rounded-[2rem] p-8 shadow-2xl relative overflow-hidden flex flex-col max-h-[85vh]" 
                },
                    React.createElement('div', { className: "relative text-center mb-6 shrink-0" },
                        React.createElement('h2', { className: "text-xl font-bold text-[#6B8E78] mb-1 tracking-wide" }, isJoining ? "åŠ å…¥æ—…ç¨‹" : "æ­¡è¿åŠ å…¥æ—…ç¨‹!"),
                        React.createElement('p', { className: "text-2xl font-bold text-stone-800" }, isJoining ? "è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±" : "è«‹å•æ‚¨æ˜¯å“ªä½æ—…ä¼´ï¼Ÿ")
                    ),

                    isJoining ? (
                        React.createElement('div', { className: "flex-1 flex flex-col gap-4 animate-fadeIn" },
                            React.createElement('input', {
                                autoFocus: true,
                                value: newName,
                                onChange: (e) => setNewName(e.target.value),
                                placeholder: "ä¾‹å¦‚ï¼šå°æ˜",
                                className: "w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl text-lg text-center font-bold text-stone-700 focus:ring-2 focus:ring-[#6B8E78] outline-none"
                            }),
                            React.createElement('button', {
                                onClick: () => { if(newName.trim()) onJoinNew(newName.trim()); },
                                disabled: !newName.trim(),
                                className: "w-full py-4 bg-[#6B8E78] text-white font-bold rounded-2xl shadow-lg hover:bg-[#5A7A66] transition-all disabled:opacity-50"
                            }, "ç¢ºèªåŠ å…¥"),
                            React.createElement('button', {
                                onClick: () => setIsJoining(false),
                                className: "w-full py-3 text-stone-400 font-bold hover:text-stone-600"
                            }, "è¿”å›æ¸…å–®")
                        )
                    ) : (
                        React.createElement('div', { className: "flex-1 overflow-y-auto pr-1" },
                            React.createElement('div', { className: "grid grid-cols-2 gap-3 pb-2" },
                                project.members.map((m, index) => 
                                    React.createElement('button', { 
                                        key: m.id, 
                                        onClick: () => onConfirm(m.id),
                                        className: "flex flex-col items-center p-3 rounded-2xl bg-stone-50 border border-stone-100 hover:border-[#6B8E78] hover:bg-green-50/50 transition-all group relative overflow-hidden shadow-sm"
                                    },
                                        React.createElement('span', { className: "text-xs text-stone-400 font-medium group-hover:text-[#6B8E78]" }, index === 0 ? "ğŸ‘‘ ä¸»è¾¦äºº" : `ğŸ’ æ—…ä¼´ ${index}`),
                                        React.createElement('div', { className: "w-full h-px bg-stone-300/50 my-2" }),
                                        React.createElement('div', { className: "w-12 h-12 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-600 font-bold group-hover:bg-[#6B8E78] group-hover:border-transparent group-hover:text-white transition-all text-lg shadow-sm" }, m.name[0]),
                                        React.createElement('div', { className: "w-full h-px bg-stone-300/50 my-2" }),
                                        React.createElement('span', { className: "text-sm font-bold text-stone-700" }, m.name)
                                    )
                                ),
                                React.createElement('button', {
                                    onClick: () => setIsJoining(true),
                                    className: "flex flex-col items-center justify-center p-4 rounded-2xl border-2 border-dashed border-stone-300 hover:border-[#6B8E78] hover:bg-stone-50 transition-all group"
                                },
                                    React.createElement('div', { className: "w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 mb-2 group-hover:text-[#6B8E78]" }, 
                                        React.createElement(UserPlus, { size: 20 })
                                    ),
                                    React.createElement('span', { className: "text-sm font-bold text-stone-500 group-hover:text-stone-700" }, "ä¸åœ¨åå–®ä¸Šï¼Ÿ"),
                                    React.createElement('span', { className: "text-xs text-stone-400" }, "é»æ“Šå»ºç«‹èº«åˆ†")
                                )
                            )
                        )
                    ),
                    !isJoining && React.createElement('button', { onClick: onClose, className: "w-full py-3 text-stone-400 text-sm hover:text-stone-600 font-medium mt-4 shrink-0" }, "å–æ¶ˆä¸¦è¿”å›")
                )
            );
        }

        // --- 3. å„€è¡¨æ¿ (ç¶­æŒä¸è®Š) ---
        function Dashboard({ project, userId, onBack, showToast, onUpdateProject, onDeleteProject, supabase }) {
            const [expenses, setExpenses] = useState([]);
            const [tab, setTab] = useState('list');
            const [showAdd, setShowAdd] = useState(false);
            const myId = localStorage.getItem(`member_${project.id}`);

            useEffect(() => {
                const fetchExp = async () => {
                    const { data } = await supabase.from('expenses').select('*').eq('project_id', project.id).order('date', { ascending: false });
                    setExpenses(data || []);
                };
                fetchExp();
                const sub = supabase.channel(`exp-${project.id}`).on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, fetchExp).subscribe();
                return () => supabase.removeChannel(sub);
            }, [project.id]);

            const stats = useMemo(() => {
                let total = 0; const catMap = {};
                expenses.forEach(e => { total += e.amount; catMap[e.category_id] = (catMap[e.category_id] || 0) + e.amount; });
                return { total, charts: Object.keys(catMap).map(k => ({ name: CATEGORIES.find(c=>c.id===k)?.name, value: catMap[k], color: CATEGORIES.find(c=>c.id===k)?.color })) };
            }, [expenses]);

            const balances = useMemo(() => {
                const bals = {}; project.members.forEach(m => bals[m.id] = 0);
                expenses.forEach(e => {
                    bals[e.payer_id] += e.amount;
                    if(e.split_type === 'custom') Object.entries(e.split_details).forEach(([id, v]) => bals[id] -= Number(v));
                    else { const ids = e.involved_ids || []; ids.forEach(id => bals[id] -= (e.amount / ids.length)); }
                });
                return bals;
            }, [expenses, project]);

            const debts = useMemo(() => {
                const d = [], c = [];
                Object.entries(balances).forEach(([id, v]) => { if(v < -1) d.push({id, v}); else if(v > 1) c.push({id, v}); });
                d.sort((a,b) => a.v - b.v); c.sort((a,b) => b.v - a.v);
                const res = []; let i=0, j=0;
                while(i < d.length && j < c.length) {
                    const amt = Math.min(Math.abs(d[i].v), c[j].v);
                    res.push({ from: d[i].id, to: c[j].id, amt });
                    d[i].v += amt; c[j].v -= amt;
                    if(Math.abs(d[i].v) < 1) i++; if(c[j].v < 1) j++;
                }
                return res;
            }, [balances]);

            const handleAdd = async (data) => {
                const { error } = await supabase.from('expenses').insert([{ ...data, project_id: project.id, created_by: userId }]);
                if(error) alert(error.message); else showToast("æ–°å¢æˆåŠŸ");
            };

            const handleDelete = async (id) => {
                if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await supabase.from('expenses').delete().eq('id', id);
            };

            return React.createElement('div', { className: "max-w-md mx-auto bg-white min-h-screen flex flex-col shadow-2xl relative" },
                // Header
                React.createElement('div', { className: "sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-stone-100 p-4 flex justify-between items-center" },
                    React.createElement('div', { className: "flex items-center gap-3" },
                        React.createElement('button', { onClick: onBack, className: "p-2 hover:bg-stone-100 rounded-full text-stone-600" }, React.createElement(ArrowLeft, { size: 22 })),
                        React.createElement('div', null, 
                            React.createElement('h2', { className: "font-bold text-stone-800 text-lg" }, project.name), 
                            React.createElement('p', { className: "text-xs text-stone-500" }, expenses.length, " ç­†å¸³ç›®")
                        )
                    ),
                    React.createElement('button', { 
                        onClick: () => setShowAdd(true), 
                        className: "text-white p-3 rounded-2xl shadow-lg hover:scale-105 transition-transform bg-[#6B8E78]"
                    }, React.createElement(Plus, { size: 24 }))
                ),
                
                // Tabs
                React.createElement('div', { className: "flex border-b border-stone-100 bg-white sticky top-[72px] z-10" },
                    [{id:'overview',icon:PieChart,label:'ç¸½è¦½'}, {id:'list',icon:List,label:'æ˜ç´°'}, {id:'members',icon:Users,label:'äººå“¡'}, {id:'settle',icon:DollarSign,label:'çµç®—'}, {id:'settings',icon:Settings,label:'è¨­å®š'}].map(t => 
                        React.createElement('button', { key: t.id, onClick: () => setTab(t.id), className: `flex-1 py-3 flex flex-col items-center gap-1 transition-all ${tab === t.id ? 'text-[#6B8E78] border-b-2 border-[#6B8E78]' : 'text-stone-400 hover:text-stone-600'}` }, 
                            React.createElement(t.icon, { size: 20 }), React.createElement('span', { className: "text-[10px] font-medium" }, t.label)
                        )
                    )
                ),

                // Content
                React.createElement('div', { className: "flex-1 p-4 bg-[#F5F5F2] overflow-y-auto" },
                    
                    // 1. æ˜ç´°åˆ—è¡¨
                    tab === 'list' && React.createElement('div', { className: "space-y-4 animate-zoom-in min-h-[50vh]" },
                        expenses.length === 0 ? React.createElement('div', { className: "flex flex-col items-center justify-center py-20 opacity-80" },
                            React.createElement('img', { src: EMPTY_IMG, className: "w-32 h-32 mb-4 opacity-80 mix-blend-multiply" }),
                            React.createElement('h3', { className: "text-stone-600 font-bold text-lg" }, "é€™è£¡ç©ºç©ºçš„"),
                            React.createElement('p', { className: "text-stone-400 text-sm mt-1" }, "é»æ“Šå³ä¸Šæ–¹ã€Œ+ã€è¨˜ä¸‹ç¬¬ä¸€ç­†èŠ±è²»å§ï¼")
                        ) :
                        expenses.map(e => React.createElement('div', { key: e.id, className: "bg-white p-4 rounded-2xl shadow-sm border border-stone-100 flex justify-between items-center group active:scale-[0.98] transition-transform" },
                            React.createElement('div', { className: "flex items-center gap-4" },
                                React.createElement('div', { className: "w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-md shrink-0 text-xl emoji-icon", style: { backgroundColor: CATEGORIES.find(c=>c.id===e.category_id)?.color } }, 
                                    CATEGORIES.find(c=>c.id===e.category_id)?.emoji || 'ğŸ“¦'
                                ),
                                React.createElement('div', null, 
                                    React.createElement('div', { className: "font-bold text-stone-800 text-lg" }, e.title), 
                                    React.createElement('div', { className: "text-xs text-stone-500 mt-1 flex items-center gap-1" }, 
                                        React.createElement(Users, { size: 10 }),
                                        project.members.find(m=>m.id===e.payer_id)?.name, " å…ˆä»˜"
                                    )
                                )
                            ),
                            React.createElement('div', { className: "text-right" }, 
                                React.createElement('div', { className: "font-bold text-stone-800 text-lg" }, formatMoney(e.amount)),
                                React.createElement('button', { onClick: () => handleDelete(e.id), className: "text-xs text-red-400 mt-1 opacity-0 group-hover:opacity-100 transition-opacity" }, "åˆªé™¤")
                            )
                        ))
                    ),

                    // 2. ç¸½è¦½
                    tab === 'overview' && React.createElement('div', { className: "space-y-4 animate-zoom-in" },
                        React.createElement('div', { className: "text-white p-6 rounded-3xl shadow-lg text-center relative overflow-hidden", style: { background: `linear-gradient(135deg, ${COLORS.primary}, ${COLORS.primaryDark})` } }, 
                            React.createElement('p', { className: "text-sm opacity-80 mb-1" }, "æœ¬æ¬¡è¡Œç¨‹ç¸½èŠ±è²»"), 
                            React.createElement('h2', { className: "text-4xl font-bold tracking-tight" }, formatMoney(stats.total)),
                            React.createElement(Activity, { className: "absolute -right-4 -bottom-4 text-white opacity-10 w-32 h-32" })
                        ),
                        React.createElement('div', { className: "bg-white p-5 rounded-3xl shadow-sm border border-stone-100" },
                             React.createElement('h3', { className: "font-bold text-stone-700 mb-4 flex items-center gap-2" }, React.createElement(PieChart, { size: 18 }), "é¡åˆ¥åˆ†æ"),
                             React.createElement('div', { className: "h-64" },
                                React.createElement(ResponsiveContainer, null, React.createElement(RePieChart, null, React.createElement(Pie, { data: stats.charts, dataKey: "value", cx: "50%", cy: "50%", innerRadius: 60, outerRadius: 80, paddingAngle: 5 }, stats.charts.map((e,i)=>React.createElement(Cell, { key: i, fill: e.color }))), React.createElement(ReTooltip), React.createElement(Legend)))
                             )
                        )
                    ),

                    // 3. äººå“¡
                    tab === 'members' && React.createElement('div', { className: "space-y-3 animate-zoom-in" },
                        project.members.map(m => React.createElement('div', { key: m.id, className: `p-4 rounded-2xl shadow-sm border flex justify-between items-center ${m.id === myId ? 'bg-[#6B8E78]/10 border-[#6B8E78]' : 'bg-white border-stone-100'}` },
                            React.createElement('div', { className: "flex items-center gap-3" },
                                React.createElement('div', { className: `w-10 h-10 rounded-full flex items-center justify-center font-bold ${m.id === myId ? 'bg-[#6B8E78] text-white' : 'bg-stone-100 text-stone-600'}` }, m.name[0]),
                                React.createElement('div', null, 
                                    React.createElement('div', { className: "font-bold text-stone-700" }, m.name),
                                    m.id === myId && React.createElement('div', { className: "text-[10px] text-[#6B8E78] font-medium" }, "é€™æ˜¯ä½ ")
                                )
                            ),
                            React.createElement('span', { className: `font-bold text-lg ${balances[m.id] >= 0 ? 'text-[#6B8E78]' : 'text-red-500'}` }, (balances[m.id] > 0 ? "+" : "") + formatMoney(balances[m.id]))
                        ))
                    ),

                    // 4. çµç®—
                    tab === 'settle' && React.createElement('div', { className: "space-y-4 animate-zoom-in" },
                        React.createElement('div', { className: "p-4 rounded-xl border bg-[#F0F4F2] border-[#D1DBD6]" },
                            React.createElement('h3', { className: "font-bold mb-1 text-[#4A6756] flex items-center gap-2" }, React.createElement(Activity, { size: 18 }), "æœ€ä½³åŒ–å»ºè­°"),
                            React.createElement('p', { className: "text-xs text-[#6B8E78]" }, "ç³»çµ±å·²è‡ªå‹•è¨ˆç®—æœ€çŸ­é‚„æ¬¾è·¯å¾‘")
                        ),
                        debts.length === 0 ? React.createElement('div', { className: "text-center py-10 bg-white rounded-2xl shadow-sm" }, "å¸³ç›®å·²çµæ¸… ğŸ‰") :
                        debts.map((d, i) => React.createElement('div', { key: i, className: "bg-white p-4 rounded-2xl shadow-sm border border-stone-100 flex items-center justify-between" },
                            React.createElement('div', { className: "flex items-center gap-3" },
                                React.createElement('span', { className: "font-bold text-stone-700" }, project.members.find(m=>m.id===d.from)?.name),
                                React.createElement(ArrowRight, { size: 16, className: "text-stone-300" }),
                                React.createElement('span', { className: "font-bold text-stone-700" }, project.members.find(m=>m.id===d.to)?.name)
                            ),
                            React.createElement('span', { className: "font-bold text-teal-700 text-lg" }, formatMoney(d.amt))
                        ))
                    ),

                    // 5. è¨­å®š
                    tab === 'settings' && React.createElement('div', { className: "space-y-6 animate-zoom-in" },
                         React.createElement('div', { className: "bg-white p-5 rounded-2xl shadow-sm border border-stone-100" },
                            React.createElement('h3', { className: "font-bold mb-4 text-stone-700 flex items-center gap-2" }, React.createElement(Edit2, { size: 16 }), "åŸºæœ¬è¨­å®š"),
                            React.createElement('div', { className: "space-y-4" },
                                React.createElement('div', null, 
                                    React.createElement('label', { className: "text-xs text-stone-500 font-medium mb-1 block" }, "è¡Œç¨‹åç¨±"),
                                    React.createElement('input', { className: "w-full border-b border-stone-200 py-2 outline-none text-stone-700 focus:border-teal-500 transition-colors", defaultValue: project.name, onBlur: (e) => onUpdateProject({ name: e.target.value }) })
                                ),
                                React.createElement('button', { onClick: () => {
                                    const url = window.location.href.split('?')[0] + '?pid=' + project.id;
                                    navigator.clipboard.writeText(url);
                                    showToast("é€£çµå·²è¤‡è£½");
                                }, className: "w-full py-3 bg-stone-50 hover:bg-stone-100 rounded-xl text-stone-600 text-sm font-medium flex justify-center items-center gap-2 transition-colors" }, React.createElement(Share2, { size: 16 }), "è¤‡è£½é‚€è«‹é€£çµ")
                            )
                         ),
                         React.createElement('div', { className: "bg-white p-5 rounded-2xl shadow-sm border border-stone-100" },
                            React.createElement('button', { onClick: onDeleteProject, className: "w-full py-3 text-red-500 text-sm font-bold hover:bg-red-50 rounded-xl transition-colors" }, "åˆªé™¤æ­¤è¡Œç¨‹ (ç„¡æ³•å¾©åŸ)")
                         )
                    )
                ),
                showAdd && React.createElement(ExpenseModal, { project, onClose: () => setShowAdd(false), onSubmit: handleAdd, supabase, defaultPayer: myId })
            );
        }

        // --- 4. è¨˜å¸³é¢æ¿ (é‡æ§‹: åŒ¯ç‡/Emoji/åˆ†å¸³å„ªåŒ–) ---
        function ExpenseModal({ project, onClose, onSubmit, supabase, defaultPayer }) {
            const [data, setData] = useState({ 
                title: '', 
                amount: '', 
                currency: 'TWD',
                category_id: 'food', 
                payer_id: defaultPayer || project.members[0].id, 
                split_type: 'equal', 
                involved_ids: project.members.map(m=>m.id),
                custom_amounts: {}
            });
            const [exchangeRate, setExchangeRate] = useState(1);
            const [uploading, setUploading] = useState(false);

            // ç•¶å¹£åˆ¥æ”¹è®Šæ™‚ï¼Œè‡ªå‹•åˆ‡æ›é è¨­åŒ¯ç‡
            const handleCurrencyChange = (curr) => {
                setData({ ...data, currency: curr });
                setExchangeRate(DEFAULT_RATES[curr] || 1);
            };

            const handleFile = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                setUploading(true);
                try {
                    const blob = await compressImage(file);
                    const name = `receipt_${Date.now()}.jpg`;
                    const { error } = await supabase.storage.from('receipts').upload(name, blob);
                    if(!error) {
                        const { data: { publicUrl } } = supabase.storage.from('receipts').getPublicUrl(name);
                        setData(p => ({ ...p, attachments: [{ type: 'image', url: publicUrl }] }));
                    }
                } catch(err) { console.error(err); alert("ä¸Šå‚³å¤±æ•—"); }
                setUploading(false);
            };

            const handleSubmit = () => {
                // 1. å¿…å¡«æª¢æŸ¥
                if (!data.title || !data.title.trim()) {
                    alert("è«‹è¼¸å…¥é …ç›®åç¨±");
                    return;
                }
                
                // 2. é‡‘é¡æª¢æŸ¥
                if (!data.amount) {
                    alert("è«‹è¼¸å…¥é‡‘é¡");
                    return;
                }

                // è¨ˆç®—æ›ç®—å¾Œçš„å°å¹£é‡‘é¡
                const finalAmount = Math.round(Number(data.amount) * exchangeRate);
                
                // --- FIX: remove custom_amounts from payload ---
                const { custom_amounts, ...cleanData } = data;
                
                const finalData = { 
                    ...cleanData, 
                    amount: finalAmount, // å­˜å…¥è³‡æ–™åº«çš„æ˜¯å°å¹£
                    original_currency: data.currency,
                    original_amount: Number(data.amount),
                    exchange_rate: exchangeRate
                };

                // é‡è¦ï¼šç¢ºä¿è‡ªè¨‚åˆ†å¸³è³‡æ–™æ­£ç¢ºä¸”æ•¸å­—åŒ–
                if (data.split_type === 'custom') {
                    const cleanCustomAmounts = {};
                    // åªä¿ç•™æœ‰å‹¾é¸çš„äºº
                    data.involved_ids.forEach(id => {
                        cleanCustomAmounts[id] = Number(data.custom_amounts[id] || 0);
                    });
                    finalData.split_details = cleanCustomAmounts;
                }

                // If user entered a title, we use it. 
                // We already checked !data.title above, so this fallback is technically redundant but safe.
                if (!finalData.title) {
                    finalData.title = CATEGORIES.find(c => c.id === data.category_id)?.name;
                }
                
                onSubmit(finalData);
                onClose();
            }
            
            const toggleInvolved = (id) => {
                let newIds;
                if(data.involved_ids.includes(id)) {
                    newIds = data.involved_ids.filter(i => i !== id);
                } else {
                    newIds = [...data.involved_ids, id];
                }
                setData({ ...data, involved_ids: newIds });
            };

            const toggleAllInvolved = () => {
                if(data.involved_ids.length === project.members.length) {
                    setData({ ...data, involved_ids: [] });
                } else {
                    setData({ ...data, involved_ids: project.members.map(m=>m.id) });
                }
            };

            const handleCustomAmountChange = (id, val) => {
                setData(prev => ({
                    ...prev,
                    custom_amounts: { ...prev.custom_amounts, [id]: val }
                }));
            };

            // è¨ˆç®—è‡ªè¨‚é‡‘é¡ç¸½å’Œ
            const currentCustomSum = data.involved_ids.reduce((sum, id) => sum + Number(data.custom_amounts[id] || 0), 0);
            const targetAmount = Math.round(Number(data.amount) * exchangeRate);
            const remainingAmount = targetAmount - currentCustomSum;
            const isCustomValid = Math.abs(remainingAmount) < 1 && data.involved_ids.length > 0;
            const isEqualValid = data.involved_ids.length > 0;
            
            // Note: We intentionally don't disable the button based on title emptiness here 
            // to allow the alert to trigger and guide the user, or we could. 
            // But consistent with "Submit" button pattern, we usually validate on click or disable.
            // Let's disable if amount is missing or logic invalid, but title we can validate on click 
            // or just disable too. Let's keep existing logic but add title check.
            const isFormValid = data.amount && !uploading && (data.split_type === 'equal' ? isEqualValid : isCustomValid);

            return React.createElement('div', { 
                onClick: onClose, 
                className: "fixed inset-0 bg-black/60 z-[60] flex items-end md:items-center justify-center backdrop-blur-sm" 
            },
                React.createElement('div', { 
                    onClick: e => e.stopPropagation(), 
                    className: "bg-white w-full max-w-md rounded-t-[2.5rem] md:rounded-[2.5rem] p-6 animate-fade-in shadow-2xl relative max-h-[90vh] overflow-y-auto flex flex-col" 
                },
                    React.createElement('div', { className: "w-12 h-1.5 bg-stone-200/60 rounded-full mx-auto mb-6 md:hidden" }),

                    // Header
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('h2', { className: "text-xl font-bold text-stone-800" }, "è¨˜ä¸€ç­†"),
                        React.createElement('button', { onClick: onClose, className: "p-2 bg-stone-100 rounded-full text-stone-500 hover:bg-stone-200" }, React.createElement(X, { size: 20 }))
                    ),

                    // 1. é‡‘é¡èˆ‡åŒ¯ç‡å€åŸŸ
                    React.createElement('div', { className: "bg-stone-50 p-4 rounded-2xl mb-6 border border-stone-100" },
                        React.createElement('div', { className: "flex gap-4 mb-3" },
                            React.createElement('div', { className: "w-1/3" },
                                React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-1 block" }, "å¹£åˆ¥"),
                                React.createElement('select', {
                                    value: data.currency,
                                    onChange: e => handleCurrencyChange(e.target.value),
                                    className: "w-full p-3 rounded-xl bg-white border border-stone-200 text-stone-700 font-bold outline-none focus:border-[#6B8E78]"
                                }, COMMON_CURRENCIES.map(c => React.createElement('option', { key: c, value: c }, c)))
                            ),
                            React.createElement('div', { className: "flex-1" },
                                React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-1 block" }, "é‡‘é¡"),
                                React.createElement('input', {
                                    type: "number",
                                    value: data.amount,
                                    onChange: e => setData({...data, amount: e.target.value}),
                                    placeholder: "0",
                                    autoFocus: true,
                                    className: "w-full p-3 rounded-xl bg-white border border-stone-200 text-stone-800 font-bold text-right outline-none focus:border-[#6B8E78] text-lg"
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex items-center gap-2 justify-end" },
                            React.createElement('label', { className: "text-xs font-bold text-stone-400" }, "åŒ¯ç‡"),
                            React.createElement('input', {
                                type: "number",
                                value: exchangeRate,
                                onChange: e => setExchangeRate(e.target.value),
                                className: "w-20 p-1.5 rounded-lg bg-white border border-stone-200 text-stone-600 text-sm text-center outline-none focus:border-[#6B8E78]"
                            }),
                            React.createElement('span', { className: "text-xs font-bold text-stone-500 ml-2" }, 
                                `â‰ˆ TWD $${new Intl.NumberFormat('zh-TW').format(targetAmount)}`
                            )
                        )
                    ),

                    // 2. é …ç›®åç¨±
                    React.createElement('div', { className: "mb-6" },
                        React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-2 block" }, "é …ç›®åç¨±"),
                        React.createElement('input', { 
                            type: "text", 
                            value: data.title, 
                            onChange: e => setData({...data, title: e.target.value}),
                            placeholder: "ä¾‹å¦‚ï¼šæ™šé¤ã€è¨ˆç¨‹è»Šè²»", 
                            className: "w-full p-3 border-b-2 border-stone-100 focus:border-[#6B8E78] outline-none text-lg font-bold text-stone-700 placeholder-stone-300 bg-transparent transition-colors"
                        })
                    ),

                    // 3. åˆ†é¡ (Emoji é¢¨æ ¼ - å¢åŠ  padding é¿å…é®æ“‹)
                    React.createElement('div', { className: "mb-8" },
                        React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-3 block" }, "åˆ†é¡"),
                        React.createElement('div', { className: "flex gap-4 overflow-x-auto p-4 scrollbar-hide snap-x -mx-4 px-4" },
                            CATEGORIES.map(cat => 
                                React.createElement('button', { 
                                    key: cat.id, 
                                    onClick: () => setData({...data, category_id: cat.id}),
                                    className: `flex flex-col items-center gap-1 min-w-[64px] snap-center transition-all ${data.category_id === cat.id ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`
                                },
                                    React.createElement('div', { 
                                        className: `w-14 h-14 rounded-full flex items-center justify-center text-3xl shadow-sm transition-all emoji-icon ${data.category_id === cat.id ? 'bg-stone-100 shadow-md ring-2 ring-[#6B8E78]' : 'bg-stone-50'}`
                                    }, cat.emoji),
                                    React.createElement('span', { className: `text-xs font-bold mt-1 ${data.category_id === cat.id ? 'text-[#6B8E78]' : 'text-stone-400'}` }, cat.name)
                                )
                            )
                        )
                    ),

                    // 4. ä»˜æ¬¾äºº
                    React.createElement('div', { className: "mb-6" },
                        React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-2 block" }, "èª°å…ˆä»˜çš„ï¼Ÿ"),
                        React.createElement('div', { className: "relative" },
                            React.createElement('select', {
                                value: data.payer_id,
                                onChange: e => setData({...data, payer_id: e.target.value}),
                                className: "w-full p-4 rounded-xl bg-stone-50 border border-stone-200 text-stone-700 font-bold outline-none appearance-none focus:border-[#6B8E78]"
                            }, project.members.map(m => React.createElement('option', { key: m.id, value: m.id }, m.name))),
                            React.createElement(UserCheck, { className: "absolute right-4 top-1/2 -translate-y-1/2 text-stone-400 pointer-events-none", size: 20 })
                        )
                    ),

                    // 5. åˆ†å¸³å€åŸŸ (å„ªåŒ–ç‰ˆ)
                    React.createElement('div', { className: "mb-6" },
                        React.createElement('div', { className: "flex justify-between items-center mb-3" },
                            React.createElement('label', { className: "text-xs font-bold text-stone-400" }, "åˆ†çµ¦èª°ï¼Ÿ"),
                            React.createElement('div', { className: "flex bg-stone-100 rounded-lg p-1" },
                                React.createElement('button', { onClick: ()=>setData({...data, split_type: 'equal'}), className: `px-3 py-1 rounded-md text-xs font-bold transition-all ${data.split_type === 'equal' ? 'bg-white shadow text-stone-800' : 'text-stone-400'}` }, "å‡åˆ†"),
                                React.createElement('button', { onClick: ()=>setData({...data, split_type: 'custom'}), className: `px-3 py-1 rounded-md text-xs font-bold transition-all ${data.split_type === 'custom' ? 'bg-white shadow text-stone-800' : 'text-stone-400'}` }, "è‡ªè¨‚")
                            )
                        ),
                        React.createElement('div', { className: "bg-stone-50 p-4 rounded-2xl border border-stone-100" },
                            data.split_type === 'equal' ? (
                                React.createElement('div', null,
                                    React.createElement('div', { className: "flex flex-wrap gap-2 mb-4" },
                                        project.members.map(m => {
                                            const isSelected = data.involved_ids.includes(m.id);
                                            return React.createElement('button', {
                                                key: m.id,
                                                onClick: () => toggleInvolved(m.id),
                                                className: `px-3 py-2 rounded-xl text-sm font-bold border transition-all flex items-center gap-2 ${isSelected ? 'bg-[#6B8E78] text-white border-transparent shadow-md' : 'bg-white text-stone-400 border-stone-200'}`
                                            }, 
                                                isSelected && React.createElement(Check, { size: 14 }),
                                                m.name
                                            )
                                        })
                                    ),
                                    React.createElement('div', { className: "flex justify-between items-center text-xs font-bold pt-2 border-t border-stone-200" },
                                        React.createElement('button', { 
                                            onClick: toggleAllInvolved, 
                                            className: "text-[#6B8E78] hover:text-[#5A7A66] transition-colors" 
                                        }, data.involved_ids.length === project.members.length ? "å–æ¶ˆå…¨é¸" : "å…¨é¸äººå“¡"),
                                        React.createElement('span', { className: "text-stone-500" }, 
                                            data.involved_ids.length === 0 ? "æœªé¸æ“‡ (å°‡è¦–ç‚ºè‡ªè¡Œå¸æ”¶)" : `æ¯äººåˆ†æ”¤: ${formatMoney(Math.round(targetAmount / (data.involved_ids.length || 1)))}`
                                        )
                                    )
                                )
                            ) : (
                                // è‡ªè¨‚åˆ†å¸³ UI
                                React.createElement('div', { className: "space-y-4" },
                                    // äººå“¡åˆ—è¡¨ (å…ˆé¡¯ç¤º)
                                    project.members.map(m => {
                                        const isChecked = data.involved_ids.includes(m.id);
                                        return React.createElement('div', { key: m.id, className: "flex items-center gap-3" },
                                            React.createElement('button', { 
                                                onClick: () => toggleInvolved(m.id),
                                                className: `w-6 h-6 rounded-md border flex items-center justify-center transition-colors ${isChecked ? 'bg-[#6B8E78] border-[#6B8E78] text-white' : 'bg-white border-stone-300'}`
                                            }, isChecked && React.createElement(Check, { size: 14 })),
                                            
                                            React.createElement('span', { className: `text-sm font-bold flex-1 ${isChecked ? 'text-stone-700' : 'text-stone-400'}` }, m.name),
                                            
                                            React.createElement('input', {
                                                type: "number",
                                                placeholder: "0",
                                                value: data.custom_amounts[m.id] || '',
                                                onChange: e => handleCustomAmountChange(m.id, e.target.value),
                                                disabled: !isChecked,
                                                className: `w-28 p-2 rounded-lg border text-right text-sm outline-none transition-colors ${isChecked ? 'bg-white border-stone-300 focus:border-[#6B8E78] text-stone-800 font-bold' : 'bg-stone-100 border-stone-200 text-stone-300 cursor-not-allowed'}`
                                            })
                                        )
                                    }),
                                    
                                    // é©—è­‰é¢æ¿ (å¾Œé¡¯ç¤º)
                                    React.createElement('div', { className: `p-3 rounded-xl border flex flex-col gap-1 text-xs font-bold ${isCustomValid ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-600'}` },
                                        React.createElement('div', { className: "flex justify-between" },
                                            React.createElement('span', null, "æ‡‰ä»˜ç¸½é¡ (å°å¹£):"),
                                            React.createElement('span', null, formatMoney(targetAmount))
                                        ),
                                        React.createElement('div', { className: "flex justify-between opacity-70" },
                                            React.createElement('span', null, "ç›®å‰åˆ†é…:"),
                                            React.createElement('span', null, formatMoney(currentCustomSum))
                                        ),
                                        React.createElement('div', { className: "flex justify-between border-t border-black/10 pt-1 mt-1" },
                                            React.createElement('span', null, "å‰©é¤˜å·®é¡:"),
                                            React.createElement('span', null, formatMoney(remainingAmount))
                                        )
                                    )
                                )
                            )
                        )
                    ),

                    // 6. æ”¶æ“šä¸Šå‚³
                    React.createElement('div', { className: "mb-8" },
                        React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-2 block" }, "æ”¶æ“š / ç…§ç‰‡"),
                        React.createElement('label', { className: "flex items-center justify-center w-full p-4 border-2 border-dashed border-stone-300 rounded-2xl cursor-pointer hover:bg-stone-50 hover:border-[#6B8E78] transition-all group" },
                            uploading ? (
                                React.createElement('div', { className: "flex items-center gap-2 text-stone-500" }, React.createElement(RefreshCw, { className: "animate-spin" }), "ä¸Šå‚³ä¸­...")
                            ) : data.attachments ? (
                                React.createElement('div', { className: "flex items-center gap-2 text-[#6B8E78] font-bold" }, React.createElement(Check, { size: 18 }), "å·²é™„åŠ ç…§ç‰‡ (é»æ“Šæ›´æ›)")
                            ) : (
                                React.createElement('div', { className: "flex flex-col items-center gap-1" },
                                    React.createElement(Camera, { className: "text-stone-400 group-hover:text-[#6B8E78] transition-colors", size: 24 }),
                                    React.createElement('span', { className: "text-xs font-bold text-stone-400 group-hover:text-stone-600" }, "æ”¯æ´æ‰‹æ©Ÿæˆªåœ–ã€JPGã€PNG")
                                )
                            ),
                            React.createElement('input', { type: "file", className: "hidden", onChange: handleFile, accept: "image/*" })
                        )
                    ),

                    // Submit Button
                    React.createElement('button', { 
                        onClick: handleSubmit,
                        disabled: !isFormValid,
                        className: `w-full py-4 text-white font-bold rounded-2xl shadow-xl text-lg hover:scale-[1.02] active:scale-95 transition-all mt-auto ${isFormValid ? 'bg-[#6B8E78] shadow-[#6B8E78]/20' : 'bg-stone-300 cursor-not-allowed'}`
                    }, uploading ? "è™•ç†ä¸­..." : (isFormValid ? "å®Œæˆ" : (data.amount ? "é‡‘é¡ä¸ç¬¦æˆ–æœªé¸äºº" : "è«‹è¼¸å…¥é‡‘é¡")))
                )
            );
        }

        // --- å…±ç”¨çµ„ä»¶ (ProjectModal, ConfirmModal ä¿æŒä¸è®Š) ---
        // ... (ProjectModal å’Œ ConfirmModal ä»£ç¢¼ä¿æŒä¸è®Šï¼Œå› ç‚ºåœ¨åŒä¸€å€‹æª”æ¡ˆä¸­ï¼Œç‚ºäº†ç°¡æ½”çœç•¥é‡è¤‡éƒ¨åˆ†ï¼Œä½†å¯¦éš›ç”Ÿæˆæ™‚æœƒåŒ…å«)
        function ConfirmModal({ title, message, onClose, onConfirm }) {
            return React.createElement('div', { 
                onClick: onClose, // é»æ“Šå¤–éƒ¨é—œé–‰
                className: "fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-6 backdrop-blur-sm" 
            },
                React.createElement('div', { 
                    onClick: e => e.stopPropagation(), 
                    className: "clean-modal w-full max-w-sm rounded-[2rem] p-8 animate-zoom-in shadow-2xl text-center" 
                },
                    React.createElement('div', { className: "w-16 h-16 bg-red-50 rounded-full flex items-center justify-center text-red-500 mx-auto mb-4" }, React.createElement(AlertTriangle, { size: 32 })),
                    React.createElement('h3', { className: "text-xl font-bold text-stone-800 mb-2" }, title),
                    React.createElement('p', { className: "text-stone-500 text-sm mb-8 leading-relaxed" }, message),
                    React.createElement('div', { className: "flex gap-3" },
                        React.createElement('button', { onClick: onClose, className: "flex-1 py-3 text-stone-500 bg-stone-100 hover:bg-stone-200 rounded-xl font-bold transition-colors" }, "å–æ¶ˆ"),
                        React.createElement('button', { onClick: onConfirm, className: "flex-1 py-3 bg-red-500 text-white hover:bg-red-600 rounded-xl font-bold shadow-lg shadow-red-500/30 transition-colors" }, "ç¢ºèªåˆªé™¤")
                    )
                )
            );
        }

        function ProjectModal({ mode, project, onClose, onSubmit, supabase }) {
            const [name, setName] = useState(project?.name || '');
            const [members, setMembers] = useState(project?.members?.map(m => m.name) || ['', '']);
            const [img, setImg] = useState(project?.background_image || DEFAULT_IMG);
            const [preview, setPreview] = useState(project?.background_image || DEFAULT_IMG);
            const [uploading, setUploading] = useState(false);

            useEffect(() => {
                if(mode==='edit' && project?.background_image && project.background_image !== DEFAULT_IMG) return;
                if(preview === DEFAULT_IMG || !preview) {
                     const match = getKeywordImage(name);
                     if(match) { setImg(match); setPreview(match); }
                }
            }, [name]);

            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setUploading(true);
                try {
                    const blob = await compressImage(file);
                    const fileName = `cover_${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`;
                    const { error } = await supabase.storage.from('receipts').upload(fileName, blob);
                    if (error) throw error;
                    const { data } = supabase.storage.from('receipts').getPublicUrl(fileName);
                    setImg(data.publicUrl); setPreview(data.publicUrl);
                } catch (err) { alert("ä¸Šå‚³å¤±æ•—"); } finally { setUploading(false); }
            };

            const handleSubmit = () => {
                const valid = members.filter(m => m.trim());
                if (!name || (mode==='create' && valid.length === 0)) return alert("è«‹è¼¸å…¥åç¨±èˆ‡æˆå“¡");
                onSubmit(name, valid, img); onClose();
            };

            return React.createElement('div', { 
                onClick: onClose, // é»æ“Šå¤–éƒ¨é—œé–‰
                className: "fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" 
            },
                React.createElement('div', { 
                    onClick: e => e.stopPropagation(), 
                    className: "clean-modal w-full max-w-lg rounded-[2.5rem] p-8 animate-zoom-in max-h-[90vh] overflow-y-auto relative" 
                },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('h2', { className: "text-2xl font-bold text-stone-700" }, mode === 'create' ? "å»ºç«‹æ–°è¡Œç¨‹" : "ç·¨è¼¯è¡Œç¨‹"),
                        React.createElement('button', { onClick: onClose }, React.createElement(X, { className: "text-stone-400 hover:text-stone-600" }))
                    ),
                    React.createElement('div', { className: "space-y-6" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-bold text-stone-500 mb-2 ml-1" }, "è¡Œç¨‹åç¨±"),
                            React.createElement('input', { className: "w-full border border-stone-200 p-4 rounded-2xl focus:ring-2 focus:ring-[#6B8E78] outline-none text-lg font-medium bg-white", placeholder: "ä¾‹å¦‚ï¼šæ±äº¬äº”æ—¥éŠ", value: name, onChange: e => setName(e.target.value) })
                        ),
                        mode === 'create' && React.createElement('div', null, 
                            React.createElement('label', { className: "block text-sm font-bold text-stone-500 mb-2 ml-1" }, "æˆå“¡ (ç¬¬ä¸€ä½ç‚ºä¸»è¾¦äºº)"),
                            React.createElement('div', { className: "grid grid-cols-2 gap-3" },
                                members.map((m, i) => React.createElement('input', { key: i, className: `w-full border p-3 rounded-2xl text-sm ${i===0?'border-yellow-300 bg-yellow-50 focus:ring-yellow-200':'border-stone-200 focus:ring-[#6B8E78]'} outline-none font-medium`, placeholder: i===0?"ğŸ‘‘ ä¸»è¾¦äºº":`ğŸ’ æ—…ä¼´ ${i}`, value: m, onChange: e => { const n = [...members]; n[i] = e.target.value; setMembers(n); } })),
                                React.createElement('button', { onClick: () => setMembers([...members, '']), className: "border border-dashed border-stone-300 p-3 rounded-2xl text-stone-400 text-sm hover:bg-stone-50 transition-colors font-medium bg-white" }, "+ å¢åŠ ")
                            )
                        ),
                        React.createElement('div', null,
                             React.createElement('div', { className: "flex justify-between items-end mb-2 ml-1" },
                                React.createElement('label', { className: "block text-lg font-bold text-stone-600" }, "å°é¢ç…§ç‰‡"),
                                React.createElement('button', { 
                                     onClick: () => { const rnd = ['https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=800','https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800','https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=800'][Math.floor(Math.random()*3)]; setImg(rnd); setPreview(rnd); },
                                     className: "text-[#6B8E78] hover:text-[#5A7A66] flex items-center gap-1 transition-colors text-xs font-bold"
                                 }, React.createElement(RefreshCw, { size: 14 }), "éš¨æ©Ÿåœ–ç‰‡")
                             ),
                             React.createElement('div', { className: "h-48 rounded-3xl bg-stone-100 relative overflow-hidden group mb-4 shadow-inner border border-stone-200", style: { backgroundImage: `url(${preview})`, backgroundSize: 'cover', backgroundPosition: 'center' } },
                                React.createElement('div', { className: "absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity" },
                                    React.createElement('span', { className: "text-white text-sm font-bold" }, "é è¦½")
                                )
                             ),
                             React.createElement('div', { className: "flex justify-between items-center pt-2" },
                                React.createElement('label', { className: "cursor-pointer text-stone-600 hover:text-[#6B8E78] text-sm font-bold flex items-center gap-2 transition-colors group" },
                                    uploading ? React.createElement(RefreshCw, { size: 16, className: "animate-spin text-[#6B8E78]" }) : React.createElement(Camera, { size: 18, className: "group-hover:scale-110 transition-transform" }), 
                                    uploading ? "ä¸Šå‚³ä¸­..." : "ä¸Šå‚³åœ–ç‰‡",
                                    React.createElement('input', { type: "file", className: "hidden", accept: "image/*", onChange: handleUpload, disabled: uploading })
                                ),
                                React.createElement('button', { 
                                     onClick: () => { setImg(DEFAULT_IMG); setPreview(DEFAULT_IMG); },
                                     className: "text-stone-400 hover:text-stone-600 text-sm font-bold flex items-center gap-2 transition-colors group"
                                 }, React.createElement(RotateCcw, { size: 16, className: "group-hover:-rotate-90 transition-transform duration-500" }), "é‡è¨­åœ–ç‰‡")
                             ),
                             React.createElement('p', { className: "text-xs text-stone-400 mt-2 ml-1" }, "å»ºè­°æ¯”ä¾‹ 16:9ï¼Œæœ€ä½³å°ºå¯¸ 800x450 åƒç´ ")
                        ),
                        React.createElement('div', { className: "flex justify-end gap-3 pt-6 border-t border-stone-100" },
                            React.createElement('button', { onClick: onClose, className: "px-6 py-3 text-stone-500 font-bold hover:bg-stone-50 rounded-2xl transition-colors" }, "å–æ¶ˆ"),
                            React.createElement('button', { onClick: handleSubmit, disabled: uploading, className: "px-8 py-3 bg-[#6B8E78] text-white rounded-2xl font-bold shadow-lg hover:bg-[#5A7A66] transition-all transform active:scale-95 disabled:opacity-50" }, uploading ? "è™•ç†ä¸­..." : (mode==='create'?"å»ºç«‹":"å„²å­˜"))
                        )
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
