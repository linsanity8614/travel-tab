<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TravelTab æ—…è²»é€š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F5F5F2; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-zoom-in { animation: zoomIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes popUp { 0% { opacity: 0; transform: translate(-50%, -40%) scale(0.9); } 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        .animate-pop-up { animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        /* éŠ€æ¡†è³ªæ„Ÿ */
        .silver-frame {
            border: 4px solid #E5E5E0;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            box-shadow: 
                0 10px 30px -5px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
        }

        /* ç´”æ·¨ Modal é¢¨æ ¼ */
        .clean-modal {
            background: #FFFFFF;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* Emoji Icon */
        .emoji-icon {
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ç®­é ­ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* ç­†è¨˜æœ¬åº•ç·šæ•ˆæœ */
        .lined-paper {
            background-image: linear-gradient(transparent 95%, #E0E0E0 95%);
            background-size: 100% 2rem; /* å°æ‡‰ line-height */
            line-height: 2rem;
            background-attachment: local; /* è®“èƒŒæ™¯éš¨æ²å‹•ç§»å‹• */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, useRef, useCallback } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        import { 
            Plus, Users, ArrowRight, Trash2, PieChart, List, DollarSign, Activity, Calendar, 
            ArrowLeft, Settings, Share2, Edit2, Check, X, Image as ImageIcon, Camera, RefreshCw,
            Crown, Upload, Info, Link as LinkIcon, AlertTriangle, UserCheck, Utensils, Bus, Bed, Ticket, ShoppingBag, Box,
            Coffee, Beer, Music, Map, RotateCcw, UserPlus, Globe, FileText, AlertCircle, Clock, History, ExternalLink,
            PenTool, Save, CheckSquare, PlusCircle, Star, Lock
        } from 'https://esm.sh/lucide-react@0.263.1';
        import { PieChart as RePieChart, Pie, Cell, ResponsiveContainer, Tooltip as ReTooltip, Legend } from 'https://esm.sh/recharts@2.7.2?deps=react@18.2.0,react-dom@18.2.0';

        // ------------------------------------------------------------------
        // 1. Supabase è¨­å®š
        // ------------------------------------------------------------------
        const SUPABASE_URL = 'https://yefoncvvbkrbonqvunzg.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_YfssF9q0n5qo436Aut4CmA_zyVhtRkx'; 

        let supabase = null;
        if (SUPABASE_URL && SUPABASE_KEY) {
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        }

        // ------------------------------------------------------------------
        // 2. è¨­å®šèˆ‡è³‡æ–™
        // ------------------------------------------------------------------
        const COLORS = { 
            primary: '#6B8E78',      
            primaryDark: '#4A6756',  
            bg: '#F5F5F2',           
            text: '#4A4A4A',         
            danger: '#EF4444',       
            accent: '#E0A986'        
        };

        const CATEGORIES = [
            { id: 'food', name: 'é£²é£Ÿ', color: '#E0A986', emoji: 'ğŸœ' },       
            { id: 'transport', name: 'äº¤é€š', color: '#8FB9A8', emoji: 'ğŸšŒ' },  
            { id: 'accommodation', name: 'ä½å®¿', color: '#A69CAC', emoji: 'ğŸ›ï¸' }, 
            { id: 'ticket', name: 'ç¥¨åˆ¸', color: '#F2CF59', emoji: 'ğŸ«' },     
            { id: 'shopping', name: 'è³¼ç‰©', color: '#88B0C9', emoji: 'ğŸ›ï¸' },
            { id: 'drink', name: 'é£²æ–™', color: '#C8A2C8', emoji: 'ğŸ¥¤' },   
            { id: 'entertainment', name: 'å¨›æ¨‚', color: '#FFB7B2', emoji: 'ğŸ¤' },
            { id: 'other', name: 'å…¶ä»–', color: '#B5B5B5', emoji: 'ğŸ“¦' },      
        ];

        const COMMON_CURRENCIES = ['TWD', 'JPY', 'KRW', 'USD', 'EUR', 'THB'];
        const DEFAULT_RATES = { 'TWD': 1, 'JPY': 0.22, 'KRW': 0.024, 'USD': 32.5, 'EUR': 35, 'THB': 0.9 };
        const CURRENCY_SYMBOLS = { 'TWD': 'NT$', 'JPY': 'Â¥', 'KRW': 'â‚©', 'USD': '$', 'EUR': 'â‚¬', 'THB': 'à¸¿' };

        const DEFAULT_IMG = 'https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800&q=80';
        const EMPTY_IMG = 'https://cdn-icons-png.flaticon.com/512/7486/7486744.png'; 

        const KEYWORD_IMAGES = {
          'æ—¥æœ¬': 'https://images.unsplash.com/photo-1542051841857-5f90071e7989?w=800&q=80',
          'æ±äº¬': 'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=800&q=80',
          'äº¬éƒ½': 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=800&q=80',
          'éŸ“åœ‹': 'https://images.unsplash.com/photo-1538485399081-7191377e8241?w=800&q=80',
          'é¦–çˆ¾': 'https://images.unsplash.com/photo-1538485399081-7191377e8241?w=800&q=80',
          'æ³°åœ‹': 'https://images.unsplash.com/photo-1552465011-b4e21bf6e79a?w=800&q=80',
          'æ›¼è°·': 'https://images.unsplash.com/photo-1508009603885-50cf7c579365?w=800&q=80',
          'æ­æ´²': 'https://images.unsplash.com/photo-1473625247510-8ceb1760943f?w=800&q=80'
        };

        const getKeywordImage = (name) => {
            if (!name) return null;
            for (const [key, url] of Object.entries(KEYWORD_IMAGES)) {
                if (name.includes(key)) return url;
            }
            return null;
        };

        const formatMoney = (v) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(v);
        const formatCurrency = (val, currencyCode) => {
            const symbol = CURRENCY_SYMBOLS[currencyCode] || '$';
            return `${symbol} ${new Intl.NumberFormat('zh-TW').format(val)}`;
        };
        const formatDate = (d) => new Date(d).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });

        const compressImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const max = 1000; 
                    if(w > h && w > max) { h *= max/w; w = max; } else if(h > max) { w *= max/h; h = max; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(resolve, 'image/jpeg', 0.8);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // ------------------------------------------------------------------
        // 3. ä¸»æ‡‰ç”¨ç¨‹å¼
        // ------------------------------------------------------------------
        function App() {
            const [view, setView] = useState('list'); 
            const [projects, setProjects] = useState([]);
            const [curProject, setCurProject] = useState(null);
            const [tempProject, setTempProject] = useState(null); 
            const [userId] = useState(() => localStorage.getItem('user_id') || crypto.randomUUID());
            const [popup, setPopup] = useState(null);
            const [showMemberSelect, setShowMemberSelect] = useState(false);

            useEffect(() => {
                localStorage.setItem('user_id', userId);
                if (!supabase) return;

                const fetchProjects = async () => {
                    const { data } = await supabase.from('projects').select('*').order('created_at', { ascending: false });
                    setProjects(data || []);
                };
                fetchProjects();

                const sub = supabase.channel('projects').on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, fetchProjects).subscribe();
                return () => supabase.removeChannel(sub);
            }, []);

            const showPopup = (msg, type = 'success') => { 
                setPopup({ msg, type }); 
                setTimeout(() => setPopup(null), 1500); 
            };

            const handleProjectClick = (project) => {
                const storedMemberId = localStorage.getItem(`member_${project.id}`);
                if (storedMemberId && project.members.find(m => m.id === storedMemberId)) {
                    setCurProject(project);
                    setView('dashboard');
                } else {
                    setTempProject(project);
                    setShowMemberSelect(true);
                }
            };

            const handleIdentityConfirm = (memberId) => {
                localStorage.setItem(`member_${tempProject.id}`, memberId);
                setCurProject(tempProject);
                setTempProject(null);
                setShowMemberSelect(false);
                setView('dashboard');
            };

            const handleJoinNewMember = async (name) => {
                if (!tempProject) return;
                const newMember = { id: crypto.randomUUID(), name }; // ç§»é™¤ note æ¬„ä½
                const updatedMembers = [...tempProject.members, newMember];
                
                const { error } = await supabase.from('projects')
                    .update({ members: updatedMembers })
                    .eq('id', tempProject.id);
                
                if (error) {
                    alert('åŠ å…¥å¤±æ•—: ' + error.message);
                } else {
                    localStorage.setItem(`member_${tempProject.id}`, newMember.id);
                    const updatedProject = { ...tempProject, members: updatedMembers };
                    setCurProject(updatedProject);
                    setTempProject(null);
                    setShowMemberSelect(false);
                    setView('dashboard');
                    showPopup(`æ­¡è¿åŠ å…¥ï¼Œ${name}ï¼`);
                }
            };

            if (!supabase) return React.createElement(ConfigScreen);

            return React.createElement('div', { className: "min-h-screen pb-safe transition-colors duration-300", style: { backgroundColor: COLORS.bg } },
                view === 'list' 
                ? React.createElement(ProjectList, { 
                    projects, 
                    onCreate: async (name, members, bg) => {
                        // ç§»é™¤ note æ¬„ä½
                        const mObjs = members.map(m => ({ id: crypto.randomUUID(), name: m }));
                        const { error } = await supabase.from('projects').insert([{ name, members: mObjs, background_image: bg, created_by: userId }]);
                        if(error) alert(error.message); else showPopup("è¡Œç¨‹å»ºç«‹æˆåŠŸ");
                    }, 
                    onSelect: handleProjectClick,
                    onDelete: async (id) => {
                         const { error } = await supabase.from('projects').delete().eq('id', id);
                         if(!error) showPopup("è¡Œç¨‹å·²åˆªé™¤");
                    },
                    onUpdate: async (id, name, bg) => {
                         const { error } = await supabase.from('projects').update({ name, background_image: bg }).eq('id', id);
                         if(!error) showPopup("æ›´æ–°æˆåŠŸ");
                    },
                    supabase 
                  })
                : React.createElement(Dashboard, { 
                    project: curProject, 
                    userId, 
                    onBack: () => setView('list'), 
                    showPopup,
                    onUpdateProject: async (updates) => {
                        await supabase.from('projects').update(updates).eq('id', curProject.id);
                        setCurProject(prev => ({ ...prev, ...updates }));
                        if (!updates.members) showPopup("è¨­å®šå·²æ›´æ–°");
                    },
                    supabase
                  }),
                
                showMemberSelect && tempProject && React.createElement(MemberSelectModal, {
                    project: tempProject,
                    onClose: () => { setShowMemberSelect(false); setTempProject(null); },
                    onConfirm: handleIdentityConfirm,
                    onJoinNew: handleJoinNewMember
                }),

                popup && React.createElement('div', { 
                    className: "fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[100] animate-pop-up" 
                },
                    React.createElement('div', { 
                        className: "bg-white/95 backdrop-blur-md px-8 py-6 rounded-3xl shadow-2xl flex flex-col items-center gap-3 border border-stone-100 min-w-[200px]" 
                    },
                        React.createElement('div', { className: `w-12 h-12 rounded-full flex items-center justify-center ${popup.type === 'error' ? 'bg-red-100 text-red-500' : 'bg-[#6B8E78]/10 text-[#6B8E78]'}` },
                            popup.type === 'error' ? React.createElement(AlertCircle, { size: 24 }) : React.createElement(Check, { size: 24, strokeWidth: 3 })
                        ),
                        React.createElement('span', { className: "text-stone-700 font-bold text-lg tracking-wide" }, popup.msg)
                    )
                )
            );
        }

        // ... (ConfigScreen, ProjectList, MemberSelectModal ä¿æŒä¸è®Š) ...
        function ConfigScreen() { return React.createElement('div', { className: "h-screen flex items-center justify-center text-center p-6" }, "è«‹è¨­å®š Supabase"); }
        function ProjectList({ projects, onCreate, onSelect, onDelete, onUpdate, supabase }) {
            const [modalMode, setModalMode] = useState(null); 
            const [targetProject, setTargetProject] = useState(null);
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            return React.createElement('div', { className: "p-4 md:p-8 max-w-6xl mx-auto min-h-screen flex flex-col pt-12" },
                React.createElement('div', { className: "silver-frame rounded-[2.5rem] p-6 md:p-10 shadow-2xl relative min-h-[600px]" },
                    React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-center mb-8 gap-4 px-2" },
                        React.createElement('div', { className: "text-center md:text-left" },
                            React.createElement('h1', { className: "text-3xl font-bold flex items-center justify-center md:justify-start gap-3 text-stone-700 tracking-tight" }, React.createElement(Activity, { className: "stroke-2 text-[#6B8E78]" }), "TravelTab"),
                            React.createElement('p', { className: "text-stone-500 text-sm mt-1 font-medium tracking-wide" }, "å‡ºåœ‹åˆ†å¸³å°å¹«æ‰‹")
                        ),
                        React.createElement('button', { onClick: () => { setTargetProject(null); setModalMode('create'); }, className: "px-6 py-3 bg-[#6B8E78] text-white rounded-2xl shadow-lg hover:bg-[#5A7A66] transition-all flex items-center gap-2 font-bold" }, React.createElement(Plus, { size: 20 }), "æ–°å¢è¡Œç¨‹")
                    ),
                    React.createElement('div', { className: "rounded-2xl p-4 md:p-8 bg-[#EBF0ED] min-h-[400px] border border-stone-200/30" },
                        projects.length === 0 ? React.createElement('div', { className: "flex flex-col items-center justify-center h-full py-24 opacity-40" }, React.createElement(Calendar, { size: 64, className: "mx-auto mb-4 text-[#6B8E78]" }), React.createElement('p', { className: "text-stone-500 font-medium" }, "é‚„æ²’æœ‰è¡Œç¨‹ï¼ŒæŒ‰å³ä¸Šæ–¹æ–°å¢")) :
                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" }, projects.map(p => {
                                let bg = p.background_image || DEFAULT_IMG;
                                if (bg === DEFAULT_IMG || !bg) { const match = getKeywordImage(p.name); if(match) bg = match; }
                                const organizer = p.members?.[0]?.name || 'ä¸»è¾¦äºº';
                                return React.createElement('div', { key: p.id, onClick: () => onSelect(p), className: "relative w-full h-64 rounded-3xl overflow-hidden shadow-md cursor-pointer group hover:shadow-xl transition-all duration-300", },
                                    React.createElement('div', { className: "absolute inset-0 bg-cover bg-center", style: { backgroundImage: `url(${bg})` } }),
                                    React.createElement('div', { className: "absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent transition-all duration-500 group-hover:from-black/90 group-hover:via-black/50 group-hover:to-black/30" }),
                                    React.createElement('div', { className: "absolute inset-0 p-6 flex flex-col justify-between z-10" },
                                        React.createElement('div', { className: "flex justify-between items-start" },
                                            React.createElement('div', { className: "bg-black/20 backdrop-blur-md px-3 py-1 rounded-full border border-white/20 group-hover:bg-black/40 transition-colors" }, React.createElement('span', { className: "text-xs text-white/90 font-medium" }, formatDate(p.created_at))),
                                            React.createElement('div', { className: "flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity" }, React.createElement('button', { onClick: (e) => { e.stopPropagation(); setTargetProject(p); setModalMode('edit'); }, className: "p-2 bg-white/20 rounded-full hover:bg-white/40 text-white backdrop-blur-md" }, React.createElement(Edit2, { size: 18 })), React.createElement('button', { onClick: (e) => { e.stopPropagation(); setDeleteConfirmId(p.id); }, className: "p-2 bg-white/20 rounded-full hover:bg-red-500/80 text-white backdrop-blur-md" }, React.createElement(Trash2, { size: 18 })))
                                        ),
                                        React.createElement('div', null, React.createElement('h3', { className: "text-white font-bold text-2xl mb-3 drop-shadow-md leading-tight truncate transition-colors" }, p.name), React.createElement('div', { className: "flex items-center justify-between" }, React.createElement('div', { className: "flex items-center gap-3 text-xs font-bold text-stone-100 bg-black/30 backdrop-blur-md px-4 py-2 rounded-xl border border-white/20 shadow-sm group-hover:bg-black/50 transition-colors" }, React.createElement('span', { className: "flex items-center gap-1.5" }, React.createElement(Crown, { size: 14, className: "text-yellow-300 fill-yellow-300" }), `ä¸»è¾¦äººï¼š${organizer}`), React.createElement('span', { className: "w-px h-3 bg-white/40" }), React.createElement('span', { className: "flex items-center gap-1.5" }, React.createElement(Users, { size: 14, className: "text-stone-200" }), `${p.members?.length || 0} äºº`)), React.createElement('div', { className: "bg-white/20 p-2 rounded-full backdrop-blur-sm group-hover:bg-[#6B8E78] transition-colors" }, React.createElement(ArrowRight, { className: "text-white", size: 20 }))))
                                    )
                                );
                            }))
                    )
                ),
                modalMode && React.createElement(ProjectModal, { mode: modalMode, project: targetProject, onClose: () => setModalMode(null), onSubmit: modalMode === 'create' ? onCreate : (n, m, b) => onUpdate(targetProject.id, n, b), supabase }),
                deleteConfirmId && React.createElement(ConfirmModal, { title: "ç¢ºèªåˆªé™¤", message: "ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ", onClose: () => setDeleteConfirmId(null), onConfirm: () => { onDelete(deleteConfirmId); setDeleteConfirmId(null); } })
            );
        }
        function MemberSelectModal({ project, onClose, onConfirm, onJoinNew }) {
             const [isJoining, setIsJoining] = useState(false); const [newName, setNewName] = useState('');
            return React.createElement('div', { onClick: onClose, className: "fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 animate-fade-in" },
                React.createElement('div', { onClick: e => e.stopPropagation(), className: "clean-modal w-full max-w-sm rounded-[2rem] p-8 shadow-2xl relative overflow-hidden flex flex-col max-h-[85vh]" },
                    React.createElement('div', { className: "relative text-center mb-6 shrink-0" }, React.createElement('h2', { className: "text-xl font-bold text-[#6B8E78] mb-1 tracking-wide" }, isJoining ? "åŠ å…¥æ—…ç¨‹" : "æ­¡è¿åŠ å…¥æ—…ç¨‹!"), React.createElement('p', { className: "text-2xl font-bold text-stone-800" }, isJoining ? "è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±" : "è«‹å•æ‚¨æ˜¯å“ªä½æ—…ä¼´ï¼Ÿ")),
                    isJoining ? (React.createElement('div', { className: "flex-1 flex flex-col gap-4 animate-fadeIn" }, React.createElement('input', { autoFocus: true, value: newName, onChange: (e) => setNewName(e.target.value), placeholder: "ä¾‹å¦‚ï¼šå°æ˜", className: "w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl text-lg text-center font-bold text-stone-700 focus:ring-2 focus:ring-[#6B8E78] outline-none" }), React.createElement('button', { onClick: () => { if(newName.trim()) onJoinNew(newName.trim()); }, disabled: !newName.trim(), className: "w-full py-4 bg-[#6B8E78] text-white font-bold rounded-2xl shadow-lg hover:bg-[#5A7A66] transition-all disabled:opacity-50" }, "ç¢ºèªåŠ å…¥"), React.createElement('button', { onClick: () => setIsJoining(false), className: "w-full py-3 text-stone-400 font-bold hover:text-stone-600" }, "è¿”å›æ¸…å–®"))) : (React.createElement('div', { className: "flex-1 overflow-y-auto pr-1" }, React.createElement('div', { className: "grid grid-cols-2 gap-3 pb-2" }, project.members.map((m, index) => React.createElement('button', { key: m.id, onClick: () => onConfirm(m.id), className: "flex flex-col items-center p-3 rounded-2xl bg-stone-50 border border-stone-100 hover:border-[#6B8E78] hover:bg-green-50/50 transition-all group relative overflow-hidden shadow-sm" }, React.createElement('span', { className: "text-xs text-stone-400 font-medium group-hover:text-[#6B8E78]" }, index === 0 ? "ğŸ‘‘ ä¸»è¾¦äºº" : `ğŸ’ æ—…ä¼´ ${index}`), React.createElement('div', { className: "w-full h-px bg-stone-300/50 my-2" }), React.createElement('div', { className: "w-12 h-12 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-600 font-bold group-hover:bg-[#6B8E78] group-hover:border-transparent group-hover:text-white transition-all text-lg shadow-sm" }, m.name[0]), React.createElement('div', { className: "w-full h-px bg-stone-300/50 my-2" }), React.createElement('span', { className: "text-sm font-bold text-stone-700" }, m.name))), React.createElement('button', { onClick: () => setIsJoining(true), className: "flex flex-col items-center justify-center p-4 rounded-2xl border-2 border-dashed border-stone-300 hover:border-[#6B8E78] hover:bg-stone-50 transition-all group" }, React.createElement('div', { className: "w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 mb-2 group-hover:text-[#6B8E78]" }, React.createElement(UserPlus, { size: 20 })), React.createElement('span', { className: "text-sm font-bold text-stone-500 group-hover:text-stone-700" }, "ä¸åœ¨åå–®ä¸Šï¼Ÿ"), React.createElement('span', { className: "text-xs text-stone-400" }, "é»æ“Šå»ºç«‹èº«åˆ†"))))), !isJoining && React.createElement('button', { onClick: onClose, className: "w-full py-3 text-stone-400 text-sm hover:text-stone-600 font-medium mt-4 shrink-0" }, "å–æ¶ˆä¸¦è¿”å›")
                )
            );
        }

        // --- 3. å„€è¡¨æ¿ ---
        function Dashboard({ project, userId, onBack, showPopup, onUpdateProject, onDeleteProject, supabase }) {
            const [expenses, setExpenses] = useState([]);
            const [tab, setTab] = useState('list');
            const [showAdd, setShowAdd] = useState(false);
            const [editingExpense, setEditingExpense] = useState(null);
            const [viewExpense, setViewExpense] = useState(null); 
            const [deleteExpenseId, setDeleteExpenseId] = useState(null); 
            
            const myId = localStorage.getItem(`member_${project.id}`);

            useEffect(() => {
                const fetchExp = async () => {
                    const { data } = await supabase.from('expenses').select('*').eq('project_id', project.id).order('date', { ascending: false });
                    setExpenses(data || []);
                };
                fetchExp();
                const sub = supabase.channel(`exp-${project.id}`).on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, fetchExp).subscribe();
                return () => supabase.removeChannel(sub);
            }, [project.id]);

            const stats = useMemo(() => {
                let total = 0; const catMap = {};
                expenses.forEach(e => { total += e.amount; catMap[e.category_id] = (catMap[e.category_id] || 0) + e.amount; });
                return { total, charts: Object.keys(catMap).map(k => ({ name: CATEGORIES.find(c=>c.id===k)?.name, value: catMap[k], color: CATEGORIES.find(c=>c.id===k)?.color })) };
            }, [expenses]);

            const balances = useMemo(() => {
                const bals = {}; project.members.forEach(m => bals[m.id] = 0);
                expenses.forEach(e => {
                    bals[e.payer_id] += e.amount;
                    if(e.split_type === 'custom') Object.entries(e.split_details).forEach(([id, v]) => bals[id] -= Number(v));
                    else { const ids = e.involved_ids || []; ids.forEach(id => bals[id] -= (e.amount / ids.length)); }
                });
                return bals;
            }, [expenses, project]);

            const debts = useMemo(() => {
                const d = [], c = [];
                Object.entries(balances).forEach(([id, v]) => { if(v < -1) d.push({id, v}); else if(v > 1) c.push({id, v}); });
                d.sort((a,b) => a.v - b.v); c.sort((a,b) => b.v - a.v);
                const res = []; let i=0, j=0;
                while(i < d.length && j < c.length) {
                    const amt = Math.min(Math.abs(d[i].v), c[j].v);
                    res.push({ from: d[i].id, to: c[j].id, amt });
                    d[i].v += amt; c[j].v -= amt;
                    if(Math.abs(d[i].v) < 1) i++; if(c[j].v < 1) j++;
                }
                return res;
            }, [balances]);

            const handleAdd = async (data) => {
                const { error } = await supabase.from('expenses').insert([{ ...data, project_id: project.id, created_by: userId }]);
                if(error) alert(error.message); else showPopup("æ–°å¢æˆåŠŸ");
            };

            const handleUpdate = async (data) => {
                const { error } = await supabase.from('expenses').update(data).eq('id', editingExpense.id);
                if(error) alert(error.message); else showPopup("ä¿®æ”¹æˆåŠŸ");
                setEditingExpense(null);
                setShowAdd(false);
            };

            const handleDeleteRequest = (id) => { setDeleteExpenseId(id); setViewExpense(null); };
            const executeDeleteExpense = async () => {
                if(!deleteExpenseId) return;
                const { error } = await supabase.from('expenses').delete().eq('id', deleteExpenseId);
                if(!error) showPopup("å·²åˆªé™¤", "error"); else alert(error.message);
                setDeleteExpenseId(null);
            };

            return React.createElement('div', { className: "max-w-md mx-auto bg-white min-h-screen flex flex-col shadow-2xl relative" },
                // Header
                React.createElement('div', { className: "sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-stone-100 p-4 flex justify-between items-center" },
                    React.createElement('div', { className: "flex items-center gap-3" },
                        React.createElement('button', { onClick: onBack, className: "p-2 hover:bg-stone-100 rounded-full text-stone-600" }, React.createElement(ArrowLeft, { size: 22 })),
                        React.createElement('div', null, 
                            React.createElement('h2', { className: "font-bold text-stone-800 text-lg" }, project.name), 
                            React.createElement('p', { className: "text-xs text-stone-500" }, expenses.length, " ç­†å¸³ç›®")
                        )
                    ),
                    React.createElement('button', { 
                        onClick: () => { setEditingExpense(null); setShowAdd(true); }, 
                        className: "text-white p-3 rounded-2xl shadow-lg hover:scale-105 transition-transform bg-[#6B8E78]"
                    }, React.createElement(Plus, { size: 24 }))
                ),
                
                // Tabs
                React.createElement('div', { className: "flex border-b border-stone-100 bg-white sticky top-[72px] z-10" },
                    [{id:'overview',icon:PieChart,label:'ç¸½è¦½'}, {id:'list',icon:List,label:'æ˜ç´°'}, {id:'members',icon:Users,label:'äººå“¡'}, {id:'settle',icon:DollarSign,label:'çµç®—'}, {id:'settings',icon:Settings,label:'è¨­å®š'}].map(t => 
                        React.createElement('button', { key: t.id, onClick: () => setTab(t.id), className: `flex-1 py-3 flex flex-col items-center gap-1 transition-all ${tab === t.id ? 'text-[#6B8E78] border-b-2 border-[#6B8E78]' : 'text-stone-400 hover:text-stone-600'}` }, 
                            React.createElement(t.icon, { size: 20 }), React.createElement('span', { className: "text-[10px] font-medium" }, t.label)
                        )
                    )
                ),

                // Content
                React.createElement('div', { className: "flex-1 p-4 bg-[#F5F5F2] overflow-y-auto" },
                    // 1. æ˜ç´°åˆ—è¡¨
                    tab === 'list' && React.createElement('div', { className: "space-y-4 animate-zoom-in min-h-[50vh]" },
                        expenses.length === 0 ? React.createElement('div', { className: "flex flex-col items-center justify-center py-20 opacity-80" }, React.createElement('img', { src: EMPTY_IMG, className: "w-32 h-32 mb-4 opacity-80 mix-blend-multiply" }), React.createElement('h3', { className: "text-stone-600 font-bold text-lg" }, "é€™è£¡ç©ºç©ºçš„"), React.createElement('p', { className: "text-stone-400 text-sm mt-1" }, "é»æ“Šå³ä¸Šæ–¹ã€Œ+ã€è¨˜ä¸‹ç¬¬ä¸€ç­†èŠ±è²»å§ï¼")) :
                        expenses.map(e => React.createElement(ExpenseItem, { key: e.id, expense: e, project: project, onClick: () => setViewExpense(e), onEdit: () => { setEditingExpense(e); setShowAdd(true); }, onDelete: () => handleDeleteRequest(e.id) }))
                    ),

                    // 2. ç¸½è¦½
                    tab === 'overview' && React.createElement('div', { className: "space-y-4 animate-zoom-in" },
                        React.createElement('div', { className: "text-white p-6 rounded-3xl shadow-lg text-center relative overflow-hidden", style: { background: `linear-gradient(135deg, ${COLORS.primary}, ${COLORS.primaryDark})` } }, React.createElement('p', { className: "text-sm opacity-80 mb-1" }, "æœ¬æ¬¡è¡Œç¨‹ç¸½èŠ±è²»"), React.createElement('h2', { className: "text-4xl font-bold tracking-tight" }, formatMoney(stats.total)), React.createElement(Activity, { className: "absolute -right-4 -bottom-4 text-white opacity-10 w-32 h-32" })),
                        React.createElement('div', { className: "bg-white p-5 rounded-3xl shadow-sm border border-stone-100" }, React.createElement('h3', { className: "font-bold text-stone-700 mb-4 flex items-center gap-2" }, React.createElement(PieChart, { size: 18 }), "é¡åˆ¥åˆ†æ"), React.createElement('div', { className: "h-64" }, React.createElement(ResponsiveContainer, null, React.createElement(RePieChart, null, React.createElement(Pie, { data: stats.charts, dataKey: "value", cx: "50%", cy: "50%", innerRadius: 60, outerRadius: 80, paddingAngle: 5 }, stats.charts.map((e,i)=>React.createElement(Cell, { key: i, fill: e.color }))), React.createElement(ReTooltip), React.createElement(Legend)))))
                    ),

                    // 3. äººå“¡ (å…¨æ–°ï¼Œä½¿ç”¨ notes è³‡æ–™è¡¨ï¼Œå‚³å…¥ showPopup)
                    tab === 'members' && React.createElement(MembersTab, { project, expenses, myId, supabase, showPopup }),

                    // 4. çµç®—
                    tab === 'settle' && React.createElement('div', { className: "space-y-4 animate-zoom-in" },
                        React.createElement('div', { className: "p-4 rounded-xl border bg-[#F0F4F2] border-[#D1DBD6]" }, React.createElement('h3', { className: "font-bold mb-1 text-[#4A6756] flex items-center gap-2" }, React.createElement(Activity, { size: 18 }), "æœ€ä½³åŒ–å»ºè­°"), React.createElement('p', { className: "text-xs text-[#6B8E78]" }, "ç³»çµ±å·²è‡ªå‹•è¨ˆç®—æœ€çŸ­é‚„æ¬¾è·¯å¾‘")),
                        debts.length === 0 ? React.createElement('div', { className: "text-center py-10 bg-white rounded-2xl shadow-sm" }, "å¸³ç›®å·²çµæ¸… ğŸ‰") :
                        debts.map((d, i) => React.createElement('div', { key: i, className: "bg-white p-4 rounded-2xl shadow-sm border border-stone-100 flex items-center justify-between" }, React.createElement('div', { className: "flex items-center gap-3" }, React.createElement('span', { className: "font-bold text-stone-700" }, project.members.find(m=>m.id===d.from)?.name), React.createElement(ArrowRight, { size: 16, className: "text-stone-300" }), React.createElement('span', { className: "font-bold text-stone-700" }, project.members.find(m=>m.id===d.to)?.name)), React.createElement('span', { className: "font-bold text-teal-700 text-lg" }, formatMoney(d.amt))))
                    ),

                    // 5. è¨­å®š
                    tab === 'settings' && React.createElement('div', { className: "space-y-6 animate-zoom-in" },
                         React.createElement('div', { className: "bg-white p-5 rounded-2xl shadow-sm border border-stone-100" }, React.createElement('h3', { className: "font-bold mb-4 text-stone-700 flex items-center gap-2" }, React.createElement(Edit2, { size: 16 }), "åŸºæœ¬è¨­å®š"), React.createElement('div', { className: "space-y-4" }, React.createElement('div', null, React.createElement('label', { className: "text-xs text-stone-500 font-medium mb-1 block" }, "è¡Œç¨‹åç¨±"), React.createElement('input', { className: "w-full border-b border-stone-200 py-2 outline-none text-stone-700 focus:border-teal-500 transition-colors", defaultValue: project.name, onBlur: (e) => onUpdateProject({ name: e.target.value }) })), React.createElement('button', { onClick: () => { const url = window.location.href.split('?')[0] + '?pid=' + project.id; navigator.clipboard.writeText(url); showPopup("é€£çµå·²è¤‡è£½"); }, className: "w-full py-3 bg-stone-50 hover:bg-stone-100 rounded-xl text-stone-600 text-sm font-medium flex justify-center items-center gap-2 transition-colors" }, React.createElement(Share2, { size: 16 }), "è¤‡è£½é‚€è«‹é€£çµ"))),
                         React.createElement('div', { className: "bg-white p-5 rounded-2xl shadow-sm border border-stone-100" }, React.createElement('button', { onClick: onDeleteProject, className: "w-full py-3 text-red-500 text-sm font-bold hover:bg-red-50 rounded-xl transition-colors" }, "åˆªé™¤æ­¤è¡Œç¨‹ (ç„¡æ³•å¾©åŸ)"))
                    )
                ),
                showAdd && React.createElement(ExpenseModal, { project, onClose: () => { setShowAdd(false); setEditingExpense(null); }, onSubmit: editingExpense ? handleUpdate : handleAdd, supabase, defaultPayer: myId, initialData: editingExpense }),
                viewExpense && React.createElement(ExpenseDetailModal, { expense: viewExpense, project, onClose: () => setViewExpense(null), onEdit: () => { setEditingExpense(viewExpense); setShowAdd(true); setViewExpense(null); }, onDelete: () => handleDeleteRequest(viewExpense.id) }),
                deleteExpenseId && React.createElement(ConfirmModal, { title: "ç¢ºèªåˆªé™¤", message: "æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†å¸³ç›®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚", onClose: () => setDeleteExpenseId(null), onConfirm: executeDeleteExpense })
            );
        }

        // --- å…¨æ–° Members Tab çµ„ä»¶ (æ•´åˆ Notes è³‡æ–™è¡¨èˆ‡ä»£è¾¦äº‹é …) ---
        function MembersTab({ project, expenses, myId, supabase, showPopup }) {
            const [selectedMemberId, setSelectedMemberId] = useState(myId || project.members[0].id);
            const [localNote, setLocalNote] = useState('');
            const [localTodos, setLocalTodos] = useState([]); // Array of {id, text, done}
            const [newTodo, setNewTodo] = useState('');
            const [isSaving, setIsSaving] = useState(false);
            
            // æ˜¯å¦ç‚ºè‡ªå·±çš„ç­†è¨˜
            const isOwnNote = selectedMemberId === myId;

            // åˆ‡æ›æˆå“¡æ™‚è¼‰å…¥è³‡æ–™
            useEffect(() => {
                const fetchNote = async () => {
                    const { data, error } = await supabase
                        .from('notes')
                        .select('content, todos')
                        .eq('project_id', project.id)
                        .eq('member_id', selectedMemberId)
                        .maybeSingle(); 
                    
                    if (data) {
                        setLocalNote(data.content || '');
                        setLocalTodos(data.todos || []);
                    } else {
                        // è‹¥ç„¡è³‡æ–™ï¼Œé è¨­ç‚ºç©º
                        setLocalNote('');
                        setLocalTodos([]);
                    }
                };
                fetchNote();
            }, [selectedMemberId, project.id, supabase]);

            // æ‰‹å‹•å„²å­˜é‚è¼¯ (æ”¹ç‚ºé»æ“ŠæŒ‰éˆ•è§¸ç™¼)
            const handleManualSave = async () => {
                if (!isOwnNote) return; // å®‰å…¨æª¢æŸ¥ï¼šéæœ¬äººç„¡æ³•å„²å­˜
                setIsSaving(true);
                
                try {
                    // å…ˆæª¢æŸ¥æ˜¯å¦å­˜åœ¨
                    const { data: existing } = await supabase
                        .from('notes')
                        .select('id')
                        .eq('project_id', project.id)
                        .eq('member_id', selectedMemberId)
                        .maybeSingle();

                    let error;
                    if (existing) {
                        const res = await supabase.from('notes').update({ 
                            content: localNote, 
                            todos: localTodos,
                            updated_at: new Date() 
                        }).eq('id', existing.id);
                        error = res.error;
                    } else {
                        // ä¿®æ­£ï¼šç”¢ç”Ÿä¸€å€‹ id
                        const res = await supabase.from('notes').insert([{ 
                            id: crypto.randomUUID(), 
                            project_id: project.id, 
                            member_id: selectedMemberId, 
                            content: localNote,
                            todos: localTodos,
                            updated_at: new Date()
                        }]);
                        error = res.error;
                    }

                    if (error) throw error;
                    showPopup("å„²å­˜æˆåŠŸ");
                } catch (e) {
                    console.error(e);
                    alert("å„²å­˜å¤±æ•—: " + e.message);
                } finally {
                    setIsSaving(false);
                }
            };

            const handleNoteChange = (e) => {
                if (!isOwnNote) return;
                setLocalNote(e.target.value);
            };

            // Todo: æ–°å¢
            const handleAddTodo = () => {
                if (!isOwnNote) return;
                if (!newTodo.trim()) return;
                const newItem = { id: crypto.randomUUID(), text: newTodo.trim(), done: false };
                const updatedTodos = [...localTodos, newItem];
                setLocalTodos(updatedTodos);
                setNewTodo('');
            };

            // Todo: å‹¾é¸
            const toggleTodo = (todoId) => {
                if (!isOwnNote) return;
                const updatedTodos = localTodos.map(t => t.id === todoId ? { ...t, done: !t.done } : t);
                setLocalTodos(updatedTodos);
            };

            // Todo: åˆªé™¤
            const deleteTodo = (todoId) => {
                if (!isOwnNote) return;
                const updatedTodos = localTodos.filter(t => t.id !== todoId);
                setLocalTodos(updatedTodos);
            };

            const stats = useMemo(() => {
                let paidTotal = 0;
                let costTotal = 0;
                const paidMap = {};
                const costMap = {};

                // Init categories
                CATEGORIES.forEach(c => { paidMap[c.id] = 0; costMap[c.id] = 0; });

                expenses.forEach(e => {
                    // Paid
                    if (e.payer_id === selectedMemberId) {
                        paidTotal += e.amount;
                        if(paidMap[e.category_id] !== undefined) paidMap[e.category_id] += e.amount;
                        else paidMap['other'] = (paidMap['other'] || 0) + e.amount;
                    }
                    
                    // Cost
                    let myShare = 0;
                    if (e.split_type === 'custom' && e.split_details) {
                        myShare = Number(e.split_details[selectedMemberId] || 0);
                    } else {
                        const ids = e.involved_ids || [];
                        if (ids.includes(selectedMemberId)) {
                            myShare = e.amount / ids.length;
                        }
                    }
                    if (myShare > 0) {
                        costTotal += myShare;
                        if(costMap[e.category_id] !== undefined) costMap[e.category_id] += myShare;
                        else costMap['other'] = (costMap['other'] || 0) + myShare;
                    }
                });

                return {
                    paidTotal,
                    costTotal,
                    paidCharts: Object.keys(paidMap).filter(k=>paidMap[k]>0).map(k => ({ name: CATEGORIES.find(c=>c.id===k)?.name, value: paidMap[k], color: CATEGORIES.find(c=>c.id===k)?.color })),
                    costCharts: Object.keys(costMap).filter(k=>costMap[k]>0).map(k => ({ name: CATEGORIES.find(c=>c.id===k)?.name, value: costMap[k], color: CATEGORIES.find(c=>c.id===k)?.color }))
                };
            }, [expenses, selectedMemberId]);

            return React.createElement('div', { className: "animate-zoom-in space-y-6" },
                // 1. æˆå“¡åˆ‡æ›å™¨ (ä¿®æ­£é ‚éƒ¨é–“è·èˆ‡å¢åŠ è‡ªæˆ‘æ¨™ç¤º)
                React.createElement('div', { className: "flex gap-3 overflow-x-auto pb-2 scrollbar-hide -mx-2 px-2 pt-4" },
                    project.members.map(m => {
                        const isMe = m.id === myId;
                        return React.createElement('button', { 
                            key: m.id, 
                            onClick: () => setSelectedMemberId(m.id),
                            className: `flex flex-col items-center min-w-[70px] transition-all duration-300 relative ${selectedMemberId === m.id ? 'scale-105 opacity-100' : 'opacity-60 hover:opacity-100'}`
                        },
                            React.createElement('div', { className: `w-14 h-14 rounded-full flex items-center justify-center text-xl shadow-sm border-2 transition-colors relative ${selectedMemberId === m.id ? 'bg-[#6B8E78] border-[#6B8E78] text-white' : 'bg-white border-white text-stone-500'}` }, 
                                m.name[0],
                                // å¦‚æœæ˜¯æœ¬äººï¼Œé¡¯ç¤ºæ˜Ÿæ˜Ÿæ¨™è¨˜
                                isMe && React.createElement('div', { className: "absolute -top-1 -right-1 bg-yellow-400 text-white rounded-full p-0.5 border-2 border-white shadow-sm" }, 
                                    React.createElement(Star, { size: 10, fill: "currentColor" })
                                )
                            ),
                            React.createElement('div', { className: "flex items-center gap-1 mt-1" },
                                React.createElement('span', { className: "text-xs font-bold text-stone-600 truncate max-w-full" }, m.name),
                                isMe && React.createElement('span', { className: "text-[10px] bg-stone-200 text-stone-600 px-1 rounded font-bold" }, "æˆ‘")
                            )
                        );
                    })
                ),

                // 2. é›™å€å¡Šåœ–è¡¨ (æ–°å¢ Legend)
                React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                    // å·¦ï¼šå·²å…ˆä»˜ (ç¶ è‰²)
                    React.createElement('div', { className: "bg-white rounded-3xl p-5 shadow-sm border border-stone-100 flex flex-col items-center text-center relative overflow-hidden" },
                        React.createElement('div', { className: "absolute top-0 left-0 right-0 h-1.5 bg-[#6B8E78]" }),
                        React.createElement('p', { className: "text-xs font-bold text-stone-400 mt-2" }, "æ˜ç´°å…§å·²å…ˆä»˜æ¬¾"),
                        React.createElement('h3', { className: "text-2xl font-bold text-[#6B8E78] my-2" }, formatMoney(stats.paidTotal)),
                        React.createElement('div', { className: "h-48 w-full mt-2" }, 
                            stats.paidCharts.length > 0 
                            ? React.createElement(ResponsiveContainer, null, React.createElement(RePieChart, null, 
                                React.createElement(Pie, { data: stats.paidCharts, dataKey: "value", cx: "50%", cy: "40%", innerRadius: 25, outerRadius: 40, paddingAngle: 5 }, stats.paidCharts.map((e,i)=>React.createElement(Cell, { key: i, fill: e.color }))), 
                                React.createElement(ReTooltip),
                                React.createElement(Legend, { iconSize: 10, wrapperStyle: { fontSize: '10px' }, verticalAlign: "bottom" })
                              ))
                            : React.createElement('div', { className: "h-full flex items-center justify-center text-xs text-stone-300" }, "ç„¡ä»˜æ¬¾ç´€éŒ„")
                        )
                    ),
                    // å³ï¼šå¯¦éš›èŠ±è²» (è—è‰²/æ©™è‰²)
                    React.createElement('div', { className: "bg-white rounded-3xl p-5 shadow-sm border border-stone-100 flex flex-col items-center text-center relative overflow-hidden" },
                        React.createElement('div', { className: "absolute top-0 left-0 right-0 h-1.5 bg-[#88B0C9]" }),
                        React.createElement('p', { className: "text-xs font-bold text-stone-400 mt-2" }, "å¯¦éš›ç¸½èŠ±è²» (çµç®—å¾Œ)"),
                        React.createElement('h3', { className: "text-2xl font-bold text-[#6B8E78] my-2" }, formatMoney(stats.costTotal)),
                        React.createElement('div', { className: "h-48 w-full mt-2" },
                            stats.costCharts.length > 0 
                            ? React.createElement(ResponsiveContainer, null, React.createElement(RePieChart, null, 
                                React.createElement(Pie, { data: stats.costCharts, dataKey: "value", cx: "50%", cy: "40%", innerRadius: 25, outerRadius: 40, paddingAngle: 5 }, stats.costCharts.map((e,i)=>React.createElement(Cell, { key: i, fill: e.color }))), 
                                React.createElement(ReTooltip),
                                React.createElement(Legend, { iconSize: 10, wrapperStyle: { fontSize: '10px' }, verticalAlign: "bottom" })
                              ))
                            : React.createElement('div', { className: "h-full flex items-center justify-center text-xs text-stone-300" }, "ç„¡æ¶ˆè²»ç´€éŒ„")
                        )
                    )
                ),

                // 3. éš¨èº«ç­†è¨˜æœ¬èˆ‡ä»£è¾¦äº‹é … (ä¿®æ­£æ¨™é¡Œé®æ“‹ï¼Œæ”¹ç‚ºæ‰‹å‹•å„²å­˜æŒ‰éˆ•)
                React.createElement('div', { className: `rounded-2xl p-6 shadow-sm border relative overflow-hidden transition-colors ${isOwnNote ? 'bg-[#FFFDE7] border-yellow-200/50' : 'bg-stone-50 border-stone-200'}` },
                    React.createElement('div', { className: `absolute top-0 left-0 w-full h-14 border-b ${isOwnNote ? 'bg-[#F0F4C3]/30 border-[#E6EE9C]' : 'bg-stone-100/50 border-stone-200'}` }), 
                    
                    // ç­†è¨˜æ¨™é¡Œå€ + å„²å­˜æŒ‰éˆ•
                    React.createElement('div', { className: `flex items-center gap-2 mb-4 relative z-10 ${isOwnNote ? 'text-yellow-800/70' : 'text-stone-500'}` },
                        React.createElement(PenTool, { size: 16 }),
                        React.createElement('span', { className: "font-bold text-sm" }, isOwnNote ? "éš¨èº«ç­†è¨˜æœ¬" : "å¤¥ä¼´çš„ç­†è¨˜æœ¬ (åƒ…ä¾›é–±è¦½)"),
                        isOwnNote ? React.createElement('button', { 
                            onClick: handleManualSave,
                            disabled: isSaving,
                            className: "ml-auto flex items-center gap-1.5 px-4 py-1.5 bg-stone-700 hover:bg-stone-800 text-[#F0F4C3] rounded-lg shadow-md hover:shadow-lg text-xs font-bold transition-all active:scale-95 disabled:opacity-70 border border-stone-600"
                        }, 
                            isSaving ? React.createElement(RefreshCw, { size: 12, className: "animate-spin" }) : React.createElement(Save, { size: 12 }),
                            isSaving ? "å„²å­˜ä¸­..." : "å„²å­˜è®Šæ›´"
                        ) : React.createElement('div', { className: "ml-auto flex items-center gap-1 text-xs text-stone-400 font-medium bg-stone-100 px-2 py-1 rounded" }, React.createElement(Lock, { size: 10 }), "å”¯è®€æ¨¡å¼")
                    ),

                    // æ–‡å­—ç­†è¨˜å€ (æœ‰åº•ç·šæ¨£å¼)
                    React.createElement('textarea', {
                        value: localNote,
                        onChange: handleNoteChange,
                        disabled: !isOwnNote,
                        placeholder: isOwnNote ? "è¨˜ä¸‹ä»£è²·æ¸…å–®ã€å‚™å¿˜éŒ„æˆ–ä»»ä½•æƒ³èªªçš„è©±... (è¼¸å…¥å®Œè¨˜å¾—é»æ“Šå³ä¸Šæ–¹å„²å­˜)" : "é€™è£¡æ²’æœ‰å…§å®¹...",
                        className: `lined-paper w-full min-h-[160px] bg-transparent border-none outline-none text-base font-medium resize-none mb-6 leading-8 tracking-wide ${isOwnNote ? 'text-stone-700 placeholder-yellow-700/30' : 'text-stone-500 cursor-default opacity-80'}`
                    }),

                    // åˆ†éš”ç·š
                    React.createElement('div', { className: `border-t border-dashed my-4 ${isOwnNote ? 'border-yellow-300' : 'border-stone-300'}` }),

                    // ä»£è¾¦äº‹é …å€
                    React.createElement('div', { className: "relative z-10" },
                        React.createElement('div', { className: `flex items-center gap-2 mb-3 ${isOwnNote ? 'text-yellow-800/70' : 'text-stone-500'}` },
                            React.createElement(CheckSquare, { size: 16 }),
                            React.createElement('span', { className: "font-bold text-sm" }, "ä»£è¾¦äº‹é …")
                        ),
                        
                        // è¼¸å…¥æ¡† (åƒ…æœ¬äººå¯è¦‹)
                        isOwnNote && React.createElement('div', { className: "flex gap-2 mb-4" },
                            React.createElement('input', {
                                value: newTodo,
                                onChange: (e) => setNewTodo(e.target.value),
                                onKeyDown: (e) => e.key === 'Enter' && handleAddTodo(),
                                placeholder: "æ–°å¢å¾…è¾¦ (è¨˜å¾—æŒ‰å„²å­˜)...",
                                className: "flex-1 bg-white/50 border border-yellow-200 rounded-xl px-3 py-2 text-sm outline-none focus:border-yellow-400 placeholder-yellow-700/30"
                            }),
                            React.createElement('button', { 
                                onClick: handleAddTodo,
                                disabled: !newTodo.trim(),
                                className: "bg-yellow-400 hover:bg-yellow-500 text-white rounded-xl p-2 transition-colors disabled:opacity-50"
                            }, React.createElement(Plus, { size: 20 }))
                        ),

                        // åˆ—è¡¨
                        React.createElement('div', { className: "space-y-2" },
                            localTodos.length === 0 ? React.createElement('div', { className: `text-center text-xs py-2 italic ${isOwnNote ? 'text-yellow-700/30' : 'text-stone-400'}` }, "å°šç„¡å¾…è¾¦äº‹é …") :
                            localTodos.map(todo => (
                                React.createElement('div', { key: todo.id, className: "flex items-center gap-3 group" },
                                    React.createElement('button', { 
                                        onClick: () => toggleTodo(todo.id),
                                        disabled: !isOwnNote,
                                        className: `w-5 h-5 rounded border flex items-center justify-center transition-all ${
                                            todo.done 
                                            ? (isOwnNote ? 'bg-yellow-400 border-yellow-400 text-white' : 'bg-stone-300 border-stone-300 text-white') 
                                            : (isOwnNote ? 'bg-white border-yellow-300 hover:border-yellow-400' : 'bg-white border-stone-300 cursor-default')
                                        }`
                                    }, todo.done && React.createElement(Check, { size: 14, strokeWidth: 3 })),
                                    React.createElement('span', { className: `flex-1 text-sm font-medium transition-colors ${todo.done ? 'text-stone-400/60 line-through' : 'text-stone-700'}` }, todo.text),
                                    isOwnNote && React.createElement('button', { 
                                        onClick: () => deleteTodo(todo.id),
                                        className: "text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"
                                    }, React.createElement(X, { size: 14 }))
                                )
                            ))
                        )
                    )
                )
            );
        }

        // --- ExpenseDetailModal (ä¿æŒä¸è®Š) ---
        function ExpenseDetailModal({ expense, project, onClose, onEdit, onDelete }) {
            const category = CATEGORIES.find(c => c.id === expense.category_id) || CATEGORIES[5];
            const payer = project.members.find(m => m.id === expense.payer_id)?.name || 'æœªçŸ¥';
            const currency = expense.original_currency || 'TWD';
            const originalAmount = expense.original_amount || expense.amount;
            const activities = expense.activities || [];

            return React.createElement('div', { 
                onClick: onClose,
                className: "fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" 
            },
                React.createElement('div', { 
                    onClick: e => e.stopPropagation(),
                    className: "bg-white w-full max-w-md rounded-2xl shadow-2xl animate-zoom-in overflow-hidden max-h-[90vh] flex flex-col" 
                },
                    // Header
                    React.createElement('div', { className: "p-5 text-white flex justify-between items-start shrink-0 relative overflow-hidden", style: { backgroundColor: category.color } },
                        React.createElement('div', { className: "relative z-10" },
                            React.createElement('div', { className: "flex items-center gap-2 opacity-90 text-sm mb-1 font-medium" },
                                React.createElement('span', { className: "emoji-icon" }, category.emoji), 
                                category.name
                            ),
                            React.createElement('h2', { className: "text-2xl font-bold tracking-wide" }, expense.title),
                            React.createElement('div', { className: "text-white/80 text-xs mt-1" }, formatDate(expense.created_at))
                        ),
                        React.createElement('button', { onClick: onClose, className: "p-2 rounded-full bg-white/20 hover:bg-white/30 relative z-10 backdrop-blur-sm" }, React.createElement(X, { size: 20 })),
                        React.createElement('div', { className: "absolute -right-4 -bottom-4 text-white opacity-20 text-[100px] leading-none emoji-icon pointer-events-none" }, category.emoji)
                    ),

                    // Content
                    React.createElement('div', { className: "p-6 space-y-6 overflow-y-auto flex-1 scrollbar-hide" },
                        // é‡‘é¡è³‡è¨Š
                        React.createElement('div', { className: "flex justify-between items-end border-b border-stone-100 pb-5" },
                            React.createElement('div', null,
                                React.createElement('label', { className: "text-xs font-bold text-stone-400 block mb-1" }, "ä»˜æ¬¾äºº"),
                                React.createElement('div', { className: "font-bold text-stone-700 text-lg flex items-center gap-2" }, 
                                    React.createElement('div', { className: "w-6 h-6 rounded-full bg-stone-200 text-stone-600 text-xs flex items-center justify-center" }, payer[0]),
                                    payer
                                )
                            ),
                            React.createElement('div', { className: "text-right" },
                                React.createElement('label', { className: "text-xs font-bold text-stone-400 block mb-1" }, "ç¸½é‡‘é¡ (å°å¹£)"),
                                React.createElement('div', { className: "font-bold text-3xl text-[#6B8E78]" }, formatMoney(expense.amount)),
                                currency !== 'TWD' && React.createElement('div', { className: "text-xs font-bold text-stone-400 mt-1" }, 
                                    `åŸå¹£: ${formatCurrency(originalAmount, currency)} (åŒ¯ç‡ ${expense.exchange_rate})`
                                )
                            )
                        ),

                        // åˆ†å¸³è©³æƒ…
                        React.createElement('div', null,
                            React.createElement('label', { className: "text-xs font-bold text-stone-400 block mb-3" }, "åˆ†å¸³è©³æƒ…"),
                            React.createElement('div', { className: "bg-stone-50 rounded-2xl p-4 space-y-2 border border-stone-100" },
                                project.members.map(m => {
                                    let amount = 0; let involved = false;
                                    if (expense.split_type === 'custom') {
                                        if (expense.split_details?.[m.id]) { amount = Number(expense.split_details[m.id]); involved = true; }
                                    } else {
                                        if (expense.involved_ids?.includes(m.id)) { amount = Number(expense.amount) / (expense.involved_ids.length || 1); involved = true; }
                                    }
                                    if (!involved) return null;
                                    return React.createElement('div', { key: m.id, className: "flex justify-between text-sm items-center" },
                                        React.createElement('span', { className: "text-stone-600 font-bold" }, m.name),
                                        React.createElement('span', { className: "font-bold text-stone-800" }, formatMoney(amount))
                                    );
                                }),
                                (!expense.involved_ids?.length && !expense.split_details) && React.createElement('div', { className: "text-center text-stone-400 text-sm" }, "è‡ªè¡Œå¸æ”¶")
                            )
                        ),
                        
                        // é™„ä»¶ (åœ–ç‰‡)
                        expense.attachments && expense.attachments.length > 0 && React.createElement('div', null,
                            React.createElement('label', { className: "text-xs font-bold text-stone-400 block mb-3" }, "é™„ä»¶"),
                            React.createElement('div', { className: "space-y-2" },
                                expense.attachments.map((att, idx) => 
                                    React.createElement('a', { key: idx, href: att.url, target: "_blank", className: "flex items-center gap-3 p-3 bg-stone-50 rounded-xl border border-stone-100 hover:bg-stone-100 transition-colors group" },
                                        React.createElement('div', { className: "w-10 h-10 rounded-lg bg-stone-200 flex items-center justify-center text-stone-500 group-hover:bg-[#6B8E78] group-hover:text-white transition-colors overflow-hidden" }, 
                                            att.type === 'image' 
                                            ? React.createElement('img', { src: att.url, className: "w-full h-full object-cover" })
                                            : React.createElement(ImageIcon, { size: 18 })
                                        ),
                                        React.createElement('div', { className: "flex-1 min-w-0" },
                                            React.createElement('div', { className: "text-xs font-bold text-stone-700 truncate" }, "æŸ¥çœ‹åœ–ç‰‡"),
                                            React.createElement('div', { className: "text-[10px] text-stone-400 truncate" }, "é»æ“Šé–‹å•Ÿ")
                                        ),
                                        React.createElement(ExternalLink, { size: 14, className: "text-stone-300" })
                                    )
                                )
                            )
                        ),

                        // ç•°å‹•ç´€éŒ„ (Timeline)
                        React.createElement('div', { className: "border-t border-stone-100 pt-6" },
                            React.createElement('label', { className: "text-xs font-bold text-stone-400 block mb-4 flex items-center gap-1" }, React.createElement(History, { size: 12 }), "ç•°å‹•ç´€éŒ„"),
                            React.createElement('div', { className: "space-y-4 pl-2" },
                                activities.length > 0 ? activities.map((act, idx) => (
                                    React.createElement('div', { key: idx, className: "relative pl-6 border-l-2 border-stone-200 last:border-transparent pb-1" },
                                        React.createElement('div', { className: "absolute -left-[5px] top-1.5 w-2.5 h-2.5 rounded-full bg-stone-300 ring-4 ring-white" }),
                                        React.createElement('div', { className: "flex flex-col" },
                                            React.createElement('div', { className: "text-xs text-stone-600" },
                                                React.createElement('span', { className: "font-bold text-stone-800" }, act.name),
                                                act.action === 'create' ? ' å»ºç«‹äº†é€™ç­†å¸³ç›®' : ' ä¿®æ”¹äº†å…§å®¹'
                                            ),
                                            React.createElement('span', { className: "text-[10px] text-stone-400 mt-0.5" }, formatDate(act.at))
                                        )
                                    )
                                )) : React.createElement('div', { className: "text-xs text-stone-400 italic pl-2" }, "å°šç„¡è©³ç´°ç´€éŒ„")
                            )
                        )
                    ),

                    // Footer Buttons (Edit on Left, Delete on Right)
                    React.createElement('div', { className: "p-4 bg-stone-50 flex justify-end gap-3 border-t border-stone-100 shrink-0" },
                        React.createElement('button', { onClick: onEdit, className: "flex items-center gap-2 px-6 py-3 bg-[#6B8E78] text-white rounded-xl hover:bg-[#5A7A66] transition-colors shadow-lg text-sm font-bold" },
                            React.createElement(Edit2, { size: 18 }), "ç·¨è¼¯"
                        ),
                        React.createElement('button', { onClick: onDelete, className: "flex items-center gap-2 px-4 py-3 text-red-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors text-sm font-bold" },
                            React.createElement(Trash2, { size: 18 }), "åˆªé™¤"
                        )
                    )
                )
            );
        }

        // --- æ–°çš„ ExpenseItem çµ„ä»¶ (å„ªåŒ–ç‰ˆé¢èˆ‡åŠŸèƒ½) ---
        function ExpenseItem({ expense, project, onClick, onEdit, onDelete }) {
            const category = CATEGORIES.find(c => c.id === expense.category_id) || CATEGORIES[5];
            const payer = project.members.find(m => m.id === expense.payer_id)?.name || 'æœªçŸ¥';
            
            // å¹£åˆ¥é¡¯ç¤ºé‚è¼¯ï¼šåˆ—è¡¨æ°¸é é¡¯ç¤ºå°å¹£ï¼Œè‹¥ç‚ºå¤–å¹£å‰‡åœ¨ä¸‹æ–¹é¡¯ç¤ºåŸå¹£
            const currencyCode = expense.original_currency || 'TWD';
            // ä¸»é‡‘é¡ = å°å¹£é‡‘é¡
            const displayAmount = formatMoney(expense.amount); 

            let splitText = '';
            if (expense.split_type === 'custom') {
                splitText = 'è‡ªè¨‚åˆ†å¸³';
            } else {
                const ids = expense.involved_ids || [];
                if (ids.length === 0) splitText = 'è‡ªè¡Œå¸æ”¶';
                else if (ids.length === project.members.length) splitText = 'æ‰€æœ‰äºº';
                else {
                    const names = ids.map(id => project.members.find(m => m.id === id)?.name || '?');
                    splitText = names.join(', ');
                }
            }

            return React.createElement('div', { 
                onClick: onClick,
                className: "bg-white rounded-2xl shadow-sm border border-stone-100 relative group overflow-hidden pl-3 py-4 pr-4 transition-all hover:shadow-md hover:-translate-y-0.5 cursor-pointer" 
            },
                // å·¦å´é¡è‰²æ¢
                React.createElement('div', { className: "absolute left-0 top-0 bottom-0 w-1.5", style: { backgroundColor: category.color } }),
                
                React.createElement('div', { className: "flex justify-between items-start mb-2" },
                    // æ¨™é¡Œèˆ‡ Icon
                    React.createElement('div', { className: "flex items-center gap-3" },
                        React.createElement('div', { className: "text-2xl emoji-icon" }, category.emoji),
                        React.createElement('h4', { className: "font-bold text-lg text-stone-800 tracking-wide" }, expense.title)
                    ),
                    // é‡‘é¡ (å›ºå®šé¡¯ç¤ºå°å¹£)
                    React.createElement('div', { className: "text-right" },
                        React.createElement('span', { className: "font-bold text-xl text-stone-700 block leading-none" }, displayAmount),
                        // è‹¥éå°å¹£ï¼Œä¸‹æ–¹é¡¯ç¤ºåŸå¹£ (ç°è‰²å°å­—)
                        currencyCode !== 'TWD' && React.createElement('span', { className: "text-xs text-stone-400 font-medium" }, 
                            `${formatCurrency(expense.original_amount, currencyCode)}`
                        )
                    )
                ),

                // ç¬¬äºŒè¡Œï¼šä»˜æ¬¾äººèˆ‡æ™‚é–“
                React.createElement('div', { className: "flex items-center justify-between text-xs text-stone-500 mb-1.5 pl-1" },
                    React.createElement('div', { className: "flex items-center gap-1.5 bg-stone-50 px-2 py-1 rounded-md" },
                        React.createElement('span', { className: "font-bold text-[#6B8E78]" }, payer),
                        React.createElement('span', null, "å…ˆä»˜")
                    ),
                    React.createElement('div', { className: "flex items-center gap-1 text-stone-400" },
                        React.createElement(Clock, { size: 10 }),
                        React.createElement('span', null, formatDate(expense.created_at))
                    )
                ),

                // ç¬¬ä¸‰è¡Œï¼šåˆ†çµ¦èª°
                React.createElement('div', { className: "flex justify-between items-end pl-1" },
                    React.createElement('div', { className: "text-xs text-stone-400 flex-1 pr-14 truncate" },
                        "åˆ†çµ¦: ", React.createElement('span', { className: "text-stone-600 font-medium" }, splitText)
                    ),
                     expense.attachments && expense.attachments.length > 0 && (
                        React.createElement(ImageIcon, { size: 14, className: "text-stone-300 mr-2" })
                    )
                )
            );
        }

        // --- 4. è¨˜å¸³é¢æ¿ (é‡æ§‹: ç•°å‹•ç´€éŒ„é‚è¼¯ + é è¦½åœ–ç‰‡) ---
        function ExpenseModal({ project, onClose, onSubmit, supabase, defaultPayer, initialData }) {
            const [data, setData] = useState(initialData ? {
                ...initialData,
                custom_amounts: initialData.split_details || {}
            } : { 
                title: '', 
                amount: '', 
                currency: 'TWD',
                category_id: 'food', 
                payer_id: defaultPayer || project.members[0].id, 
                split_type: 'equal', 
                involved_ids: project.members.map(m=>m.id),
                custom_amounts: {}
            });
            
            const [exchangeRate, setExchangeRate] = useState(initialData?.exchange_rate || 1);
            const [uploading, setUploading] = useState(false);
            const [previewUrl, setPreviewUrl] = useState(null); // æ–°å¢é è¦½ URL

            // ç•¶å¹£åˆ¥æ”¹è®Šæ™‚ï¼Œè‡ªå‹•åˆ‡æ›é è¨­åŒ¯ç‡
            const handleCurrencyChange = (curr) => {
                setData({ ...data, currency: curr });
                setExchangeRate(DEFAULT_RATES[curr] || 1);
            };

            const handleFile = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                // ç«‹å³é è¦½
                const objectUrl = URL.createObjectURL(file);
                setPreviewUrl(objectUrl);

                setUploading(true);
                try {
                    const blob = await compressImage(file);
                    const name = `receipt_${Date.now()}.jpg`;
                    const { error } = await supabase.storage.from('receipts').upload(name, blob);
                    if(!error) {
                        const { data: { publicUrl } } = supabase.storage.from('receipts').getPublicUrl(name);
                        setData(p => ({ ...p, attachments: [{ type: 'image', url: publicUrl }] }));
                    }
                } catch(err) { console.error(err); alert("ä¸Šå‚³å¤±æ•—"); }
                setUploading(false);
            };

            const handleSubmit = () => {
                if (!data.title || !data.title.trim()) { alert("è«‹è¼¸å…¥é …ç›®åç¨±"); return; }
                if (!data.amount) { alert("è«‹è¼¸å…¥é‡‘é¡"); return; }

                const finalAmount = Math.round(Number(data.amount) * exchangeRate);
                
                // --- Activity Log Logic ---
                const myId = localStorage.getItem(`member_${project.id}`);
                const myName = project.members.find(m => m.id === myId)?.name || 'æœªçŸ¥æˆå“¡';
                const newActivity = {
                    action: initialData ? 'update' : 'create',
                    at: new Date().toISOString(),
                    by: myId,
                    name: myName
                };
                const updatedActivities = [...(initialData?.activities || []), newActivity];

                const { custom_amounts, id, created_at, ...cleanData } = data;
                
                const finalData = { 
                    ...cleanData, 
                    amount: finalAmount, 
                    original_currency: data.currency,
                    original_amount: Number(data.amount),
                    exchange_rate: exchangeRate,
                    activities: updatedActivities // åŠ å…¥ç•°å‹•ç´€éŒ„
                };

                if (data.split_type === 'custom') {
                    const cleanCustomAmounts = {};
                    data.involved_ids.forEach(id => {
                        cleanCustomAmounts[id] = Number(data.custom_amounts[id] || 0);
                    });
                    finalData.split_details = cleanCustomAmounts;
                }

                if (!finalData.title) finalData.title = CATEGORIES.find(c => c.id === data.category_id)?.name;
                
                onSubmit(finalData);
                onClose();
            }
            
            // ... (Toggle Logic çœç•¥ï¼Œèˆ‡ä¹‹å‰ç›¸åŒ)
            const toggleInvolved = (id) => {
                let newIds;
                if(data.involved_ids.includes(id)) {
                    newIds = data.involved_ids.filter(i => i !== id);
                } else {
                    newIds = [...data.involved_ids, id];
                }
                setData({ ...data, involved_ids: newIds });
            };

            const toggleAllInvolved = () => {
                if(data.involved_ids.length === project.members.length) {
                    setData({ ...data, involved_ids: [] });
                } else {
                    setData({ ...data, involved_ids: project.members.map(m=>m.id) });
                }
            };

            const handleCustomAmountChange = (id, val) => {
                setData(prev => ({
                    ...prev,
                    custom_amounts: { ...prev.custom_amounts, [id]: val }
                }));
            };

            const currentCustomSum = data.involved_ids.reduce((sum, id) => sum + Number(data.custom_amounts[id] || 0), 0);
            const targetAmount = Math.round(Number(data.amount) * exchangeRate);
            const remainingAmount = targetAmount - currentCustomSum;
            const isCustomValid = Math.abs(remainingAmount) < 1 && data.involved_ids.length > 0;
            const isEqualValid = data.involved_ids.length > 0;
            const isFormValid = data.amount && !uploading && (data.split_type === 'equal' ? isEqualValid : isCustomValid);

            return React.createElement('div', { 
                onClick: onClose, 
                className: "fixed inset-0 bg-black/60 z-[60] flex items-end md:items-center justify-center backdrop-blur-sm" 
            },
                React.createElement('div', { 
                    onClick: e => e.stopPropagation(), 
                    className: "bg-white w-full max-w-md rounded-t-[2.5rem] md:rounded-[2.5rem] p-6 animate-fade-in shadow-2xl relative max-h-[90vh] overflow-y-auto flex flex-col" 
                },
                    React.createElement('div', { className: "w-12 h-1.5 bg-stone-200/60 rounded-full mx-auto mb-6 md:hidden" }),

                    // Header
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('h2', { className: "text-xl font-bold text-stone-800" }, initialData ? "ç·¨è¼¯å¸³ç›®" : "è¨˜ä¸€ç­†"),
                        React.createElement('button', { onClick: onClose, className: "p-2 bg-stone-100 rounded-full text-stone-500 hover:bg-stone-200" }, React.createElement(X, { size: 20 }))
                    ),

                    // ... (é‡‘é¡ã€åç¨±ã€åˆ†é¡ã€ä»˜æ¬¾äºº UI ä¿æŒä¸è®Š)
                     // 1. é‡‘é¡èˆ‡åŒ¯ç‡å€åŸŸ
                    React.createElement('div', { className: "bg-stone-50 p-4 rounded-2xl mb-6 border border-stone-100" },
                        React.createElement('div', { className: "flex gap-4 mb-3" },
                            React.createElement('div', { className: "w-1/3" },
                                React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-1 block" }, "å¹£åˆ¥"),
                                React.createElement('select', {
                                    value: data.currency,
                                    onChange: e => handleCurrencyChange(e.target.value),
                                    className: "w-full p-3 rounded-xl bg-white border border-stone-200 text-stone-700 font-bold outline-none focus:border-[#6B8E78]"
                                }, COMMON_CURRENCIES.map(c => React.createElement('option', { key: c, value: c }, `${c} ${CURRENCY_SYMBOLS[c]}`)))
                            ),
                            React.createElement('div', { className: "flex-1" },
                                React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-1 block" }, "é‡‘é¡"),
                                React.createElement('input', {
                                    type: "number",
                                    value: data.amount,
                                    onChange: e => setData({...data, amount: e.target.value}),
                                    placeholder: "0",
                                    autoFocus: !initialData,
                                    className: "w-full p-3 rounded-xl bg-white border border-stone-200 text-stone-800 font-bold text-right outline-none focus:border-[#6B8E78] text-lg"
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex items-center gap-2 justify-end" },
                            React.createElement('label', { className: "text-xs font-bold text-stone-400" }, "åŒ¯ç‡"),
                            React.createElement('input', {
                                type: "number",
                                value: exchangeRate,
                                onChange: e => setExchangeRate(e.target.value),
                                className: "w-20 p-1.5 rounded-lg bg-white border border-stone-200 text-stone-600 text-sm text-center outline-none focus:border-[#6B8E78]"
                            }),
                            React.createElement('span', { className: "text-xs font-bold text-stone-500 ml-2" }, 
                                `â‰ˆ TWD $${new Intl.NumberFormat('zh-TW').format(targetAmount)}`
                            )
                        )
                    ),

                    // 2. é …ç›®åç¨±
                    React.createElement('div', { className: "mb-6" },
                        React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-2 block" }, "é …ç›®åç¨±"),
                        React.createElement('input', { 
                            type: "text", 
                            value: data.title, 
                            onChange: e => setData({...data, title: e.target.value}),
                            placeholder: "ä¾‹å¦‚ï¼šæ™šé¤ã€è¨ˆç¨‹è»Šè²»", 
                            className: "w-full p-3 border-b-2 border-stone-100 focus:border-[#6B8E78] outline-none text-lg font-bold text-stone-700 placeholder-stone-300 bg-transparent transition-colors"
                        })
                    ),

                    // 3. åˆ†é¡
                    React.createElement('div', { className: "mb-8" },
                        React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-3 block" }, "åˆ†é¡"),
                        React.createElement('div', { className: "flex gap-4 overflow-x-auto p-4 scrollbar-hide snap-x -mx-4 px-4" },
                            CATEGORIES.map(cat => 
                                React.createElement('button', { 
                                    key: cat.id, 
                                    onClick: () => setData({...data, category_id: cat.id}),
                                    className: `flex flex-col items-center gap-1 min-w-[64px] snap-center transition-all ${data.category_id === cat.id ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`
                                },
                                    React.createElement('div', { 
                                        className: `w-14 h-14 rounded-full flex items-center justify-center text-3xl shadow-sm transition-all emoji-icon ${data.category_id === cat.id ? 'bg-stone-100 shadow-md ring-2 ring-[#6B8E78]' : 'bg-stone-50'}`
                                    }, cat.emoji),
                                    React.createElement('span', { className: `text-xs font-bold mt-1 ${data.category_id === cat.id ? 'text-[#6B8E78]' : 'text-stone-400'}` }, cat.name)
                                )
                            )
                        )
                    ),

                    // 4. ä»˜æ¬¾äºº
                    React.createElement('div', { className: "mb-6" },
                        React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-2 block" }, "èª°å…ˆä»˜çš„ï¼Ÿ"),
                        React.createElement('div', { className: "relative" },
                            React.createElement('select', {
                                value: data.payer_id,
                                onChange: e => setData({...data, payer_id: e.target.value}),
                                className: "w-full p-4 rounded-xl bg-stone-50 border border-stone-200 text-stone-700 font-bold outline-none appearance-none focus:border-[#6B8E78]"
                            }, project.members.map(m => React.createElement('option', { key: m.id, value: m.id }, m.name))),
                            React.createElement(UserCheck, { className: "absolute right-4 top-1/2 -translate-y-1/2 text-stone-400 pointer-events-none", size: 20 })
                        )
                    ),

                    // 5. åˆ†å¸³å€åŸŸ
                    React.createElement('div', { className: "mb-6" },
                         React.createElement('div', { className: "flex justify-between items-center mb-3" },
                            React.createElement('label', { className: "text-xs font-bold text-stone-400" }, "åˆ†çµ¦èª°ï¼Ÿ"),
                            React.createElement('div', { className: "flex bg-stone-100 rounded-lg p-1" },
                                React.createElement('button', { onClick: ()=>setData({...data, split_type: 'equal'}), className: `px-3 py-1 rounded-md text-xs font-bold transition-all ${data.split_type === 'equal' ? 'bg-white shadow text-stone-800' : 'text-stone-400'}` }, "å‡åˆ†"),
                                React.createElement('button', { onClick: ()=>setData({...data, split_type: 'custom'}), className: `px-3 py-1 rounded-md text-xs font-bold transition-all ${data.split_type === 'custom' ? 'bg-white shadow text-stone-800' : 'text-stone-400'}` }, "è‡ªè¨‚")
                            )
                        ),
                        React.createElement('div', { className: "bg-stone-50 p-4 rounded-2xl border border-stone-100" },
                            data.split_type === 'equal' ? (
                                React.createElement('div', null,
                                    React.createElement('div', { className: "flex flex-wrap gap-2 mb-4" },
                                        project.members.map(m => {
                                            const isSelected = data.involved_ids.includes(m.id);
                                            return React.createElement('button', {
                                                key: m.id,
                                                onClick: () => toggleInvolved(m.id),
                                                className: `px-3 py-2 rounded-xl text-sm font-bold border transition-all flex items-center gap-2 ${isSelected ? 'bg-[#6B8E78] text-white border-transparent shadow-md' : 'bg-white text-stone-400 border-stone-200'}`
                                            }, 
                                                isSelected && React.createElement(Check, { size: 14 }),
                                                m.name
                                            )
                                        })
                                    ),
                                    React.createElement('div', { className: "flex justify-between items-center text-xs font-bold pt-2 border-t border-stone-200" },
                                        React.createElement('button', { 
                                            onClick: toggleAllInvolved, 
                                            className: "text-[#6B8E78] hover:text-[#5A7A66] transition-colors" 
                                        }, data.involved_ids.length === project.members.length ? "å–æ¶ˆå…¨é¸" : "å…¨é¸äººå“¡"),
                                        React.createElement('span', { className: "text-stone-500" }, 
                                            data.involved_ids.length === 0 ? "æœªé¸æ“‡ (å°‡è¦–ç‚ºè‡ªè¡Œå¸æ”¶)" : `æ¯äººåˆ†æ”¤: ${formatMoney(Math.round(targetAmount / (data.involved_ids.length || 1)))}`
                                        )
                                    )
                                )
                            ) : (
                                // è‡ªè¨‚åˆ†å¸³ UI
                                React.createElement('div', { className: "space-y-4" },
                                    project.members.map(m => {
                                        const isChecked = data.involved_ids.includes(m.id);
                                        return React.createElement('div', { key: m.id, className: "flex items-center gap-3" },
                                            React.createElement('button', { 
                                                onClick: () => toggleInvolved(m.id),
                                                className: `w-6 h-6 rounded-md border flex items-center justify-center transition-colors ${isChecked ? 'bg-[#6B8E78] border-[#6B8E78] text-white' : 'bg-white border-stone-300'}`
                                            }, isChecked && React.createElement(Check, { size: 14 })),
                                            React.createElement('span', { className: `text-sm font-bold flex-1 ${isChecked ? 'text-stone-700' : 'text-stone-400'}` }, m.name),
                                            React.createElement('input', {
                                                type: "number",
                                                placeholder: "0",
                                                value: data.custom_amounts[m.id] || '',
                                                onChange: e => handleCustomAmountChange(m.id, e.target.value),
                                                disabled: !isChecked,
                                                className: `w-28 p-2 rounded-lg border text-right text-sm outline-none transition-colors ${isChecked ? 'bg-white border-stone-300 focus:border-[#6B8E78] text-stone-800 font-bold' : 'bg-stone-100 border-stone-200 text-stone-300 cursor-not-allowed'}`
                                            })
                                        )
                                    }),
                                    React.createElement('div', { className: `p-3 rounded-xl border flex flex-col gap-1 text-xs font-bold ${isCustomValid ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-600'}` },
                                        React.createElement('div', { className: "flex justify-between" },
                                            React.createElement('span', null, "æ‡‰ä»˜ç¸½é¡ (å°å¹£):"),
                                            React.createElement('span', null, formatMoney(targetAmount))
                                        ),
                                        React.createElement('div', { className: "flex justify-between opacity-70" },
                                            React.createElement('span', null, "ç›®å‰åˆ†é…:"),
                                            React.createElement('span', null, formatMoney(currentCustomSum))
                                        ),
                                        React.createElement('div', { className: "flex justify-between border-t border-black/10 pt-1 mt-1" },
                                            React.createElement('span', null, "å‰©é¤˜å·®é¡:"),
                                            React.createElement('span', null, formatMoney(remainingAmount))
                                        )
                                    )
                                )
                            )
                        )
                    ),
                    
                    // 6. æ”¶æ“šä¸Šå‚³ (æ›´æ–°ï¼šé è¦½ç¸®åœ–)
                    React.createElement('div', { className: "mb-8" },
                        React.createElement('label', { className: "text-xs font-bold text-stone-400 mb-2 block" }, "è«‹ä¸Šå‚³åœ–ç‰‡/æˆªåœ–(PNG,SVG,JPG...ç­‰)"),
                        
                        // é è¦½å€å¡Š
                        (previewUrl || (data.attachments && data.attachments[0])) && React.createElement('div', { className: "mb-3 relative w-full h-40 rounded-2xl overflow-hidden border border-stone-200" },
                             React.createElement('img', { 
                                src: previewUrl || data.attachments[0].url, 
                                className: "w-full h-full object-cover" 
                             }),
                             React.createElement('div', { className: "absolute inset-0 bg-black/20" })
                        ),

                        React.createElement('label', { className: "flex items-center justify-center w-full p-4 border-2 border-dashed border-stone-300 rounded-2xl cursor-pointer hover:bg-stone-50 hover:border-[#6B8E78] transition-all group" },
                            uploading ? (
                                React.createElement('div', { className: "flex items-center gap-2 text-stone-500" }, React.createElement(RefreshCw, { className: "animate-spin" }), "ä¸Šå‚³ä¸­...")
                            ) : (data.attachments && data.attachments.length > 0 && !previewUrl) ? (
                                React.createElement('div', { className: "flex items-center gap-2 text-[#6B8E78] font-bold" }, React.createElement(Check, { size: 18 }), "å·²é™„åŠ ç…§ç‰‡ (é»æ“Šæ›´æ›)")
                            ) : (
                                React.createElement('div', { className: "flex flex-col items-center gap-1" },
                                    React.createElement(Camera, { className: "text-stone-400 group-hover:text-[#6B8E78] transition-colors", size: 24 }),
                                    React.createElement('span', { className: "text-xs font-bold text-stone-400 group-hover:text-stone-600" }, previewUrl ? "æ›´æ›åœ–ç‰‡" : "é¸æ“‡åœ–ç‰‡")
                                )
                            ),
                            React.createElement('input', { type: "file", className: "hidden", onChange: handleFile, accept: "image/*" })
                        )
                    ),

                    // Submit Button
                    React.createElement('button', { 
                        onClick: handleSubmit,
                        disabled: !isFormValid,
                        className: `w-full py-4 text-white font-bold rounded-2xl shadow-xl text-lg hover:scale-[1.02] active:scale-95 transition-all mt-auto ${isFormValid ? 'bg-[#6B8E78] shadow-[#6B8E78]/20' : 'bg-stone-300 cursor-not-allowed'}`
                    }, uploading ? "è™•ç†ä¸­..." : (isFormValid ? (initialData ? "å„²å­˜è®Šæ›´" : "å®Œæˆ") : (data.amount ? "é‡‘é¡ä¸ç¬¦æˆ–æœªé¸äºº" : "è«‹è¼¸å…¥é‡‘é¡")))
                )
            );
        }

        // --- å…±ç”¨çµ„ä»¶ (ProjectModal, ConfirmModal ä¿æŒä¸è®Š) ---
        function ConfirmModal({ title, message, onClose, onConfirm }) {
            return React.createElement('div', { onClick: onClose, className: "fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-6 backdrop-blur-sm" },
                React.createElement('div', { onClick: e => e.stopPropagation(), className: "clean-modal w-full max-w-sm rounded-[2rem] p-8 animate-zoom-in shadow-2xl text-center" },
                    React.createElement('div', { className: "w-16 h-16 bg-red-50 rounded-full flex items-center justify-center text-red-500 mx-auto mb-4" }, React.createElement(AlertTriangle, { size: 32 })),
                    React.createElement('h3', { className: "text-xl font-bold text-stone-800 mb-2" }, title),
                    React.createElement('p', { className: "text-stone-500 text-sm mb-8 leading-relaxed" }, message),
                    React.createElement('div', { className: "flex gap-3" }, React.createElement('button', { onClick: onClose, className: "flex-1 py-3 text-stone-500 bg-stone-100 hover:bg-stone-200 rounded-xl font-bold transition-colors" }, "å–æ¶ˆ"), React.createElement('button', { onClick: onConfirm, className: "flex-1 py-3 bg-red-500 text-white hover:bg-red-600 rounded-xl font-bold shadow-lg shadow-red-500/30 transition-colors" }, "ç¢ºèªåˆªé™¤"))
                )
            );
        }
        function ProjectModal({ mode, project, onClose, onSubmit, supabase }) {
            const [name, setName] = useState(project?.name || '');
            const [members, setMembers] = useState(project?.members?.map(m => m.name) || ['', '']);
            const [img, setImg] = useState(project?.background_image || DEFAULT_IMG);
            const [preview, setPreview] = useState(project?.background_image || DEFAULT_IMG);
            const [uploading, setUploading] = useState(false);
            useEffect(() => { if(mode==='edit' && project?.background_image && project.background_image !== DEFAULT_IMG) return; if(preview === DEFAULT_IMG || !preview) { const match = getKeywordImage(name); if(match) { setImg(match); setPreview(match); } } }, [name]);
            const handleUpload = async (e) => { const file = e.target.files[0]; if (!file) return; setUploading(true); try { const blob = await compressImage(file); const fileName = `cover_${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`; const { error } = await supabase.storage.from('receipts').upload(fileName, blob); if (error) throw error; const { data } = supabase.storage.from('receipts').getPublicUrl(fileName); setImg(data.publicUrl); setPreview(data.publicUrl); } catch (err) { alert("ä¸Šå‚³å¤±æ•—"); } finally { setUploading(false); } };
            const handleSubmit = () => { const valid = members.filter(m => m.trim()); if (!name || (mode==='create' && valid.length === 0)) return alert("è«‹è¼¸å…¥åç¨±èˆ‡æˆå“¡"); onSubmit(name, valid, img); onClose(); };
            return React.createElement('div', { onClick: onClose, className: "fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" },
                React.createElement('div', { onClick: e => e.stopPropagation(), className: "clean-modal w-full max-w-lg rounded-[2.5rem] p-8 animate-zoom-in max-h-[90vh] overflow-y-auto relative" },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" }, React.createElement('h2', { className: "text-2xl font-bold text-stone-700" }, mode === 'create' ? "å»ºç«‹æ–°è¡Œç¨‹" : "ç·¨è¼¯è¡Œç¨‹"), React.createElement('button', { onClick: onClose }, React.createElement(X, { className: "text-stone-400 hover:text-stone-600" }))),
                    React.createElement('div', { className: "space-y-6" },
                        React.createElement('div', null, React.createElement('label', { className: "block text-sm font-bold text-stone-500 mb-2 ml-1" }, "è¡Œç¨‹åç¨±"), React.createElement('input', { className: "w-full border border-stone-200 p-4 rounded-2xl focus:ring-2 focus:ring-[#6B8E78] outline-none text-lg font-medium bg-white", placeholder: "ä¾‹å¦‚ï¼šæ±äº¬äº”æ—¥éŠ", value: name, onChange: e => setName(e.target.value) })),
                        mode === 'create' && React.createElement('div', null, React.createElement('label', { className: "block text-sm font-bold text-stone-500 mb-2 ml-1" }, "æˆå“¡ (ç¬¬ä¸€ä½ç‚ºä¸»è¾¦äºº)"), React.createElement('div', { className: "grid grid-cols-2 gap-3" }, members.map((m, i) => React.createElement('input', { key: i, className: `w-full border p-3 rounded-2xl text-sm ${i===0?'border-yellow-300 bg-yellow-50 focus:ring-yellow-200':'border-stone-200 focus:ring-[#6B8E78]'} outline-none font-medium`, placeholder: i===0?"ğŸ‘‘ ä¸»è¾¦äºº":`ğŸ’ æ—…ä¼´ ${i}`, value: m, onChange: e => { const n = [...members]; n[i] = e.target.value; setMembers(n); } })), React.createElement('button', { onClick: () => setMembers([...members, '']), className: "border border-dashed border-stone-300 p-3 rounded-2xl text-stone-400 text-sm hover:bg-stone-50 transition-colors font-medium bg-white" }, "+ å¢åŠ "))),
                        React.createElement('div', null, React.createElement('div', { className: "flex justify-between items-end mb-2 ml-1" }, React.createElement('label', { className: "block text-lg font-bold text-stone-600" }, "å°é¢ç…§ç‰‡"), React.createElement('button', { onClick: () => { const rnd = ['https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=800','https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800','https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=800'][Math.floor(Math.random()*3)]; setImg(rnd); setPreview(rnd); }, className: "text-[#6B8E78] hover:text-[#5A7A66] flex items-center gap-1 transition-colors text-xs font-bold" }, React.createElement(RefreshCw, { size: 14 }), "éš¨æ©Ÿåœ–ç‰‡")), React.createElement('div', { className: "h-48 rounded-3xl bg-stone-100 relative overflow-hidden group mb-4 shadow-inner border border-stone-200", style: { backgroundImage: `url(${preview})`, backgroundSize: 'cover', backgroundPosition: 'center' } }, React.createElement('div', { className: "absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity" }, React.createElement('span', { className: "text-white text-sm font-bold" }, "é è¦½"))), React.createElement('div', { className: "flex justify-between items-center pt-2" }, React.createElement('label', { className: "cursor-pointer text-stone-600 hover:text-[#6B8E78] text-sm font-bold flex items-center gap-2 transition-colors group" }, uploading ? React.createElement(RefreshCw, { size: 16, className: "animate-spin text-[#6B8E78]" }) : React.createElement(Camera, { size: 18, className: "group-hover:scale-110 transition-transform" }), uploading ? "ä¸Šå‚³ä¸­..." : "ä¸Šå‚³åœ–ç‰‡", React.createElement('input', { type: "file", className: "hidden", accept: "image/*", onChange: handleUpload, disabled: uploading })), React.createElement('button', { onClick: () => { setImg(DEFAULT_IMG); setPreview(DEFAULT_IMG); }, className: "text-stone-400 hover:text-stone-600 text-sm font-bold flex items-center gap-2 transition-colors group" }, React.createElement(RotateCcw, { size: 16, className: "group-hover:-rotate-90 transition-transform duration-500" }), "é‡è¨­åœ–ç‰‡")), React.createElement('p', { className: "text-xs text-stone-400 mt-2 ml-1" }, "å»ºè­°æ¯”ä¾‹ 16:9ï¼Œæœ€ä½³å°ºå¯¸ 800x450 åƒç´ ")),
                        React.createElement('div', { className: "flex justify-end gap-3 pt-6 border-t border-stone-100" }, React.createElement('button', { onClick: onClose, className: "px-6 py-3 text-stone-500 font-bold hover:bg-stone-50 rounded-2xl transition-colors" }, "å–æ¶ˆ"), React.createElement('button', { onClick: handleSubmit, disabled: uploading, className: "px-8 py-3 bg-[#6B8E78] text-white rounded-2xl font-bold shadow-lg hover:bg-[#5A7A66] transition-all transform active:scale-95 disabled:opacity-50" }, uploading ? "è™•ç†ä¸­..." : (mode==='create'?"å»ºç«‹":"å„²å­˜")))
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
