<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TravelTab æ—…è²»é€š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F5F5F2; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-zoom-in { animation: zoomIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        import { 
            Plus, Users, ArrowRight, Trash2, PieChart, List, DollarSign, Activity, Calendar, 
            ArrowLeft, Settings, Share2, Edit2, Check, X, Image as ImageIcon, Camera, RefreshCw,
            Crown, Upload, Info, Link as LinkIcon
        } from 'https://esm.sh/lucide-react@0.263.1';
        import { PieChart as RePieChart, Pie, Cell, ResponsiveContainer, Tooltip as ReTooltip, Legend } from 'https://esm.sh/recharts@2.7.2?deps=react@18.2.0,react-dom@18.2.0';

        // ------------------------------------------------------------------
        // 1. Supabase è¨­å®šå€
        // ------------------------------------------------------------------
        // ðŸ”´ è«‹åœ¨ä¸‹æ–¹å¡«å…¥æ‚¨çš„ URL å’Œ Key
        const SUPABASE_URL = 'https://yefoncvvbkrbonqvunzg.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_YfssF9q0n5qo436Aut4CmA_zyVhtRkx'; 

        let supabase = null;
        if (SUPABASE_URL && SUPABASE_KEY) {
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        }

        // ------------------------------------------------------------------
        // 2. æ¨£å¼å¸¸æ•¸ (Morandi Color Palette)
        // ------------------------------------------------------------------
        const COLORS = { 
            primary: '#6B8E78',      // é¼ å°¾è‰ç¶  (ä¸»è‰²)
            primaryDark: '#4A6756',  // æ·±ç¶ 
            bg: '#F5F5F2',           // ç±³ç™½èƒŒæ™¯
            white: '#FFFFFF',
            text: '#4A4A4A',         // æ·±ç°æ–‡å­—
            textLight: '#8C8C8C',    // æ·ºç°æ–‡å­—
            danger: '#EF4444',       
            accent: '#E0A986'        // é™¶åœŸè‰² (é»žç¶´)
        };

        const CATEGORIES = [
            { id: 'food', name: 'é£²é£Ÿ', color: '#E0A986' },       
            { id: 'transport', name: 'äº¤é€š', color: '#8FB9A8' },  
            { id: 'accommodation', name: 'ä½å®¿', color: '#A69CAC' }, 
            { id: 'ticket', name: 'ç¥¨åˆ¸', color: '#F2CF59' },     
            { id: 'shopping', name: 'è³¼ç‰©', color: '#88B0C9' },   
            { id: 'other', name: 'å…¶ä»–', color: '#B5B5B5' },      
        ];

        const DEFAULT_IMG = 'https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800&q=80';
        
        // é—œéµå­—å°æ‡‰åœ–ç‰‡ (è®“ç•«é¢æ›´æ¼‚äº®)
        const KEYWORD_IMAGES = {
          'æ—¥æœ¬': 'https://images.unsplash.com/photo-1542051841857-5f90071e7989?w=800&q=80',
          'æ±äº¬': 'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=800&q=80',
          'äº¬éƒ½': 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=800&q=80',
          'éŸ“åœ‹': 'https://images.unsplash.com/photo-1538485399081-7191377e8241?w=800&q=80',
          'é¦–çˆ¾': 'https://images.unsplash.com/photo-1538485399081-7191377e8241?w=800&q=80',
          'æ³°åœ‹': 'https://images.unsplash.com/photo-1552465011-b4e21bf6e79a?w=800&q=80',
          'æ›¼è°·': 'https://images.unsplash.com/photo-1508009603885-50cf7c579365?w=800&q=80',
          'æ­æ´²': 'https://images.unsplash.com/photo-1473625247510-8ceb1760943f?w=800&q=80'
        };

        const getKeywordImage = (name) => {
            if (!name) return null;
            for (const [key, url] of Object.entries(KEYWORD_IMAGES)) {
                if (name.includes(key)) return url;
            }
            return null;
        };

        const formatMoney = (v) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(v);
        const formatDate = (d) => new Date(d).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });

        // åœ–ç‰‡å£“ç¸® (ä¸Šå‚³ç”¨)
        const compressImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const max = 800;
                    if(w > h && w > max) { h *= max/w; w = max; } else if(h > max) { w *= max/h; h = max; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(resolve, 'image/jpeg', 0.7);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // ------------------------------------------------------------------
        // 3. ä¸»æ‡‰ç”¨ç¨‹å¼ (App)
        // ------------------------------------------------------------------
        function App() {
            const [view, setView] = useState('list'); // list | dashboard
            const [projects, setProjects] = useState([]);
            const [curProject, setCurProject] = useState(null);
            const [userId] = useState(() => localStorage.getItem('user_id') || crypto.randomUUID());
            const [toast, setToast] = useState(null);

            useEffect(() => {
                localStorage.setItem('user_id', userId);
                if (!supabase) return;

                const fetchProjects = async () => {
                    const { data } = await supabase.from('projects').select('*').order('created_at', { ascending: false });
                    setProjects(data || []);
                };
                fetchProjects();

                const sub = supabase.channel('projects').on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, fetchProjects).subscribe();
                return () => supabase.removeChannel(sub);
            }, []);

            const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };

            // å°šæœªè¨­å®š Key çš„ç•«é¢
            if (!supabase) return React.createElement(ConfigScreen);

            return React.createElement('div', { className: "min-h-screen pb-safe transition-colors duration-300", style: { backgroundColor: COLORS.bg } },
                view === 'list' 
                ? React.createElement(ProjectList, { 
                    projects, 
                    onCreate: async (name, members, bg) => {
                        const mObjs = members.map(m => ({ id: crypto.randomUUID(), name: m }));
                        const { error } = await supabase.from('projects').insert([{ name, members: mObjs, background_image: bg, created_by: userId }]);
                        if(error) alert(error.message); else showToast("è¡Œç¨‹å»ºç«‹æˆåŠŸ");
                    }, 
                    onSelect: (p) => { setCurProject(p); setView('dashboard'); },
                    onDelete: async (id) => {
                         const { error } = await supabase.from('projects').delete().eq('id', id);
                         if(!error) showToast("è¡Œç¨‹å·²åˆªé™¤");
                    },
                    onUpdate: async (id, name, bg) => {
                         const { error } = await supabase.from('projects').update({ name, background_image: bg }).eq('id', id);
                         if(!error) showToast("æ›´æ–°æˆåŠŸ");
                    }
                  })
                : React.createElement(Dashboard, { 
                    project: curProject, 
                    userId, 
                    onBack: () => setView('list'), 
                    showToast,
                    onUpdateProject: async (updates) => {
                        await supabase.from('projects').update(updates).eq('id', curProject.id);
                        setCurProject(prev => ({ ...prev, ...updates }));
                        showToast("è¨­å®šå·²æ›´æ–°");
                    },
                    onDeleteProject: async () => {
                        if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿè³‡æ–™å°‡ç„¡æ³•å¾©åŽŸã€‚")) {
                            await supabase.from('projects').delete().eq('id', curProject.id);
                            setView('list');
                        }
                    }
                  }),
                
                toast && React.createElement('div', { className: "fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl z-50 flex items-center gap-2 animate-fade-in" }, 
                    React.createElement(Check, { size: 18, className: "text-green-400" }), toast
                )
            );
        }

        // --- è¨­å®šç•«é¢ ---
        function ConfigScreen() {
            return React.createElement('div', { className: "h-screen flex flex-col items-center justify-center p-6 text-center bg-[#F5F5F2]" },
                React.createElement('div', { className: "bg-white p-8 rounded-3xl shadow-xl max-w-sm" },
                    React.createElement(Activity, { size: 48, className: "mx-auto text-teal-700 mb-4" }),
                    React.createElement('h2', { className: "text-xl font-bold mb-2 text-stone-700" }, "å°šæœªé€£ç·šè‡³ Supabase"),
                    React.createElement('p', { className: "text-stone-500 text-sm mb-6" }, "è«‹ä½¿ç”¨ç¨‹å¼ç¢¼ç·¨è¼¯å™¨æ‰“é–‹ index.htmlï¼Œä¸¦åœ¨ç¬¬ 35-36 è¡Œå¡«å…¥æ‚¨çš„ Supabase URL å’Œ Keyã€‚"),
                    React.createElement('div', { className: "bg-stone-100 p-3 rounded-xl text-xs font-mono text-left overflow-x-auto text-stone-600" }, 
                        "const SUPABASE_URL = '...';", React.createElement('br'),
                        "const SUPABASE_KEY = '...';"
                    )
                )
            );
        }

        // --- å°ˆæ¡ˆåˆ—è¡¨ (ç²¾ç¾ŽéŠ€æ¡†ç‰ˆ) ---
        function ProjectList({ projects, onCreate, onSelect, onDelete, onUpdate }) {
            const [modalMode, setModalMode] = useState(null); 
            const [targetProject, setTargetProject] = useState(null);

            return React.createElement('div', { className: "p-4 md:p-8 max-w-5xl mx-auto min-h-screen flex flex-col pt-12" },
                // å¤–å±¤éŠ€æ¡†
                React.createElement('div', { className: "border-4 border-stone-300 rounded-[2rem] p-6 md:p-8 bg-white/60 shadow-2xl backdrop-blur-md relative" },
                    
                    // æ¨™é¡Œå€
                    React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-center mb-8 gap-4" },
                        React.createElement('div', { className: "text-center md:text-left" },
                            React.createElement('h1', { className: "text-3xl font-bold flex items-center justify-center md:justify-start gap-3 text-stone-700 tracking-tight" }, 
                                React.createElement(Activity, { className: "stroke-2 text-teal-700" }), "TravelTab æ—…è²»é€š"
                            ),
                            React.createElement('p', { className: "text-stone-500 text-sm mt-1 font-medium tracking-wide" }, "å‡ºåœ‹åˆ†å¸³å°å¹«æ‰‹ (Supabase ç‰ˆ)")
                        ),
                        React.createElement('button', { 
                            onClick: () => { setTargetProject(null); setModalMode('create'); },
                            className: "px-6 py-3 rounded-xl shadow-lg flex items-center gap-2 transition-transform hover:-translate-y-0.5 text-white font-bold bg-[#6B8E78]"
                        }, React.createElement(Plus, { size: 20 }), "æ–°å¢žè¡Œç¨‹")
                    ),

                    // å…§å±¤åˆ—è¡¨å€ (æ·ºç°åº•)
                    React.createElement('div', { className: "border-2 border-stone-200 rounded-2xl p-4 md:p-6 bg-stone-50/50 min-h-[400px]" },
                        projects.length === 0 
                        ? React.createElement('div', { className: "flex flex-col items-center justify-center h-full py-20 opacity-50" }, 
                            React.createElement('div', { className: "bg-white p-4 rounded-full shadow-sm mb-4" }, React.createElement(Calendar, { size: 40, className: "text-stone-300" })),
                            React.createElement('h3', { className: "text-stone-600 font-medium text-lg" }, "ç›®å‰æ²’æœ‰è¡Œç¨‹"),
                            React.createElement('p', { className: "text-stone-400 mt-2" }, "é»žæ“Šå³ä¸Šè§’æ–°å¢žä¸€å€‹å§ï¼")
                          )
                        : React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" }, 
                            projects.map(p => {
                                let bg = p.background_image || DEFAULT_IMG;
                                if (bg === DEFAULT_IMG || !bg) {
                                    const match = getKeywordImage(p.name);
                                    if(match) bg = match;
                                }

                                return React.createElement('div', { 
                                    key: p.id, 
                                    onClick: () => onSelect(p), 
                                    className: "relative h-48 rounded-2xl overflow-hidden shadow-md cursor-pointer group hover:shadow-xl hover:-translate-y-1 transition-all duration-300",
                                    style: { backgroundImage: `url(${bg})`, backgroundSize: 'cover', backgroundPosition: 'center' }
                                },
                                    React.createElement('div', { className: "absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-black/20 group-hover:via-black/40 transition-all" }),
                                    React.createElement('div', { className: "absolute inset-0 p-5 flex flex-col justify-between" },
                                        React.createElement('div', { className: "flex justify-between items-start" },
                                            React.createElement('h3', { className: "text-white font-bold text-xl drop-shadow-md truncate pr-2 flex-1" }, p.name),
                                            React.createElement('div', { className: "flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity" },
                                                React.createElement('button', { 
                                                    onClick: (e) => { e.stopPropagation(); setTargetProject(p); setModalMode('edit'); },
                                                    className: "p-1.5 bg-white/20 rounded-full hover:bg-white/40 text-white backdrop-blur-sm"
                                                }, React.createElement(Edit2, { size: 14 })),
                                                React.createElement('button', { 
                                                    onClick: (e) => { e.stopPropagation(); if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) onDelete(p.id); },
                                                    className: "p-1.5 bg-white/20 rounded-full hover:bg-red-500/80 text-white backdrop-blur-sm"
                                                }, React.createElement(Trash2, { size: 14 }))
                                            )
                                        ),
                                        React.createElement('div', { className: "flex justify-between items-end text-white/90" },
                                            React.createElement('div', { className: "flex items-center gap-2" },
                                                React.createElement('div', { className: "flex items-center gap-1 bg-white/20 backdrop-blur-sm px-2 py-1 rounded-lg border border-white/10" },
                                                    React.createElement(Crown, { size: 12, className: "text-yellow-300 fill-yellow-300" }),
                                                    React.createElement('span', { className: "text-xs font-medium" }, p.members?.[0]?.name || 'ä¸»è¾¦äºº')
                                                ),
                                                React.createElement('div', { className: "flex items-center gap-1 text-xs" }, React.createElement(Users, { size: 12 }), p.members?.length || 0, " äºº")
                                            ),
                                            React.createElement('div', { className: "bg-white/20 p-1.5 rounded-full group-hover:bg-[#6B8E78] transition-colors" }, React.createElement(ArrowRight, { size: 16 }))
                                        )
                                    )
                                );
                            })
                          )
                    )
                ),
                modalMode && React.createElement(ProjectModal, { 
                    mode: modalMode,
                    project: targetProject,
                    onClose: () => setModalMode(null), 
                    onSubmit: modalMode === 'create' ? onCreate : (n, m, b) => onUpdate(targetProject.id, n, b) 
                })
            );
        }

        // å°ˆæ¡ˆ Modal (å»ºç«‹/ç·¨è¼¯)
        function ProjectModal({ mode, project, onClose, onSubmit }) {
            const [name, setName] = useState(project?.name || '');
            const [members, setMembers] = useState(project?.members?.map(m => m.name) || ['', '']);
            const [img, setImg] = useState(project?.background_image || DEFAULT_IMG);
            const [preview, setPreview] = useState(project?.background_image || DEFAULT_IMG);

            // è‡ªå‹•é…åœ–
            useEffect(() => {
                if(mode==='edit') return;
                const match = getKeywordImage(name);
                if(match) { setImg(match); setPreview(match); }
            }, [name]);

            const handleFile = async (e) => {
                if(e.target.files[0]) {
                    const blob = await compressImage(e.target.files[0]);
                    const reader = new FileReader();
                    reader.onload = (ev) => { setImg(ev.target.result); setPreview(ev.target.result); }; // æš«æ™‚é è¦½ Base64ï¼Œå¯¦éš›å»ºè­°ä¸Šå‚³
                    reader.readAsDataURL(blob);
                }
            };

            const handleSubmit = () => {
                const valid = members.filter(m => m.trim());
                if (!name || (mode==='create' && valid.length === 0)) return alert("è«‹è¼¸å…¥åç¨±èˆ‡æˆå“¡");
                onSubmit(name, valid, img); 
                onClose();
            };

            return React.createElement('div', { className: "fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm" },
                React.createElement('div', { className: "bg-white w-full max-w-lg rounded-3xl p-6 animate-zoom-in max-h-[90vh] overflow-y-auto" },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('h2', { className: "text-xl font-bold text-stone-700" }, mode === 'create' ? "å»ºç«‹æ–°è¡Œç¨‹" : "ç·¨è¼¯è¡Œç¨‹"),
                        React.createElement('button', { onClick: onClose }, React.createElement(X, { className: "text-stone-400" }))
                    ),
                    React.createElement('div', { className: "space-y-5" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-stone-500 mb-1" }, "è¡Œç¨‹åç¨±"),
                            React.createElement('input', { className: "w-full border border-stone-200 p-2.5 rounded-xl focus:ring-2 focus:ring-[#6B8E78] outline-none", placeholder: "ä¾‹å¦‚ï¼šæ±äº¬äº”æ—¥éŠ", value: name, onChange: e => setName(e.target.value) })
                        ),
                        mode === 'create' && React.createElement('div', null, 
                            React.createElement('label', { className: "block text-sm font-medium text-stone-500 mb-1" }, "æˆå“¡ (ç¬¬ä¸€ä½ç‚ºä¸»è¾¦äºº)"),
                            React.createElement('div', { className: "grid grid-cols-2 gap-2" },
                                members.map((m, i) => React.createElement('input', { 
                                    key: i, 
                                    className: `w-full border p-2 rounded-xl text-sm ${i===0?'border-yellow-300 bg-yellow-50':''}`, 
                                    placeholder: i===0?"ðŸ‘‘ ä¸»è¾¦äºº":`å¤¥ä¼´ ${i+1}`, 
                                    value: m, 
                                    onChange: e => { const n = [...members]; n[i] = e.target.value; setMembers(n); } 
                                })),
                                React.createElement('button', { onClick: () => setMembers([...members, '']), className: "border border-dashed p-2 rounded-xl text-stone-400 text-sm hover:bg-stone-50" }, "+ å¢žåŠ ")
                            )
                        ),
                        React.createElement('div', null,
                             React.createElement('label', { className: "block text-sm font-medium text-stone-500 mb-2" }, "å°é¢ç…§ç‰‡"),
                             React.createElement('div', { className: "h-40 rounded-xl bg-stone-100 relative overflow-hidden group mb-2", style: { backgroundImage: `url(${preview})`, backgroundSize: 'cover' } },
                                React.createElement('div', { className: "absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity" },
                                    React.createElement('label', { className: "cursor-pointer bg-black/60 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2" },
                                        React.createElement(Camera, { size: 16 }), "æ›´æ›",
                                        React.createElement('input', { type: "file", className: "hidden", accept: "image/*", onChange: handleFile })
                                    )
                                )
                             ),
                             React.createElement('button', { 
                                 onClick: () => { const rnd = ['https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=800','https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800'][Math.floor(Math.random()*2)]; setImg(rnd); setPreview(rnd); },
                                 className: "text-xs text-stone-500 flex items-center gap-1 hover:text-[#6B8E78]"
                             }, React.createElement(RefreshCw, { size: 12 }), "éš¨æ©Ÿåœ–ç‰‡")
                        ),
                        React.createElement('div', { className: "flex justify-end gap-2 pt-4 border-t" },
                            React.createElement('button', { onClick: onClose, className: "px-5 py-2.5 text-stone-500 font-medium hover:bg-stone-50 rounded-xl" }, "å–æ¶ˆ"),
                            React.createElement('button', { onClick: handleSubmit, className: "px-6 py-2.5 bg-[#6B8E78] text-white rounded-xl font-bold shadow-md hover:bg-[#5A7A66]" }, mode==='create'?"å»ºç«‹":"å„²å­˜")
                        )
                    )
                )
            );
        }

        // --- å„€è¡¨æ¿ (é‚„åŽŸ Tab å’Œ Stats) ---
        function Dashboard({ project, userId, onBack, showToast, onUpdateProject, onDeleteProject }) {
            const [expenses, setExpenses] = useState([]);
            const [tab, setTab] = useState('list'); // overview, list, members, settle, settings
            const [showAdd, setShowAdd] = useState(false);

            useEffect(() => {
                const fetchExp = async () => {
                    const { data } = await supabase.from('expenses').select('*').eq('project_id', project.id).order('date', { ascending: false });
                    setExpenses(data || []);
                };
                fetchExp();
                const sub = supabase.channel(`exp-${project.id}`).on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, fetchExp).subscribe();
                return () => supabase.removeChannel(sub);
            }, [project.id]);

            const stats = useMemo(() => {
                let total = 0; const catMap = {};
                expenses.forEach(e => { total += e.amount; catMap[e.category_id] = (catMap[e.category_id] || 0) + e.amount; });
                return { total, charts: Object.keys(catMap).map(k => ({ name: CATEGORIES.find(c=>c.id===k)?.name, value: catMap[k], color: CATEGORIES.find(c=>c.id===k)?.color })) };
            }, [expenses]);

            const balances = useMemo(() => {
                const bals = {}; project.members.forEach(m => bals[m.id] = 0);
                expenses.forEach(e => {
                    bals[e.payer_id] += e.amount;
                    if(e.split_type === 'custom') Object.entries(e.split_details).forEach(([id, v]) => bals[id] -= Number(v));
                    else { const ids = e.involved_ids || []; ids.forEach(id => bals[id] -= (e.amount / ids.length)); }
                });
                return bals;
            }, [expenses, project]);

            const debts = useMemo(() => {
                const d = [], c = [];
                Object.entries(balances).forEach(([id, v]) => { if(v < -1) d.push({id, v}); else if(v > 1) c.push({id, v}); });
                d.sort((a,b) => a.v - b.v); c.sort((a,b) => b.v - a.v);
                const res = []; let i=0, j=0;
                while(i < d.length && j < c.length) {
                    const amt = Math.min(Math.abs(d[i].v), c[j].v);
                    res.push({ from: d[i].id, to: c[j].id, amt });
                    d[i].v += amt; c[j].v -= amt;
                    if(Math.abs(d[i].v) < 1) i++; if(c[j].v < 1) j++;
                }
                return res;
            }, [balances]);

            const handleAdd = async (data) => {
                const { error } = await supabase.from('expenses').insert([{ ...data, project_id: project.id, created_by: userId }]);
                if(error) alert(error.message); else showToast("æ–°å¢žæˆåŠŸ");
            };

            const handleDelete = async (id) => {
                if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await supabase.from('expenses').delete().eq('id', id);
            };

            return React.createElement('div', { className: "max-w-md mx-auto bg-white min-h-screen flex flex-col shadow-2xl" },
                // Header
                React.createElement('div', { className: "sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-stone-100 p-3 flex justify-between items-center" },
                    React.createElement('div', { className: "flex items-center gap-2" },
                        React.createElement('button', { onClick: onBack, className: "p-2 hover:bg-stone-100 rounded-full text-stone-600 transition-colors" }, React.createElement(ArrowLeft, { size: 20 })),
                        React.createElement('div', null, 
                            React.createElement('h2', { className: "font-bold text-stone-800" }, project.name), 
                            React.createElement('p', { className: "text-xs text-stone-500" }, expenses.length, " ç­†å¸³ç›®")
                        )
                    ),
                    React.createElement('button', { 
                        onClick: () => setShowAdd(true), 
                        className: "text-white p-2.5 rounded-full shadow-lg hover:scale-105 transition-transform" ,
                        style: { backgroundColor: COLORS.primary }
                    }, React.createElement(Plus, { size: 24 }))
                ),
                
                // Tabs (é‚„åŽŸæ¼‚äº®çš„ Tab æ¨£å¼)
                React.createElement('div', { className: "flex border-b border-stone-100 bg-white sticky top-[60px] z-10" },
                    [{id:'overview',icon:PieChart,label:'ç¸½è¦½'}, {id:'list',icon:List,label:'æ˜Žç´°'}, {id:'members',icon:Users,label:'äººå“¡'}, {id:'settle',icon:DollarSign,label:'çµç®—'}, {id:'settings',icon:Settings,label:'è¨­å®š'}].map(t => 
                        React.createElement('button', { key: t.id, onClick: () => setTab(t.id), className: `flex-1 py-3 flex flex-col items-center gap-1 transition-all ${tab === t.id ? 'text-[#6B8E78] border-b-2 border-[#6B8E78]' : 'text-stone-400 hover:text-stone-600'}` }, 
                            React.createElement(t.icon, { size: 18 }), React.createElement('span', { className: "text-[10px] font-medium" }, t.label)
                        )
                    )
                ),

                // Content
                React.createElement('div', { className: "flex-1 p-4 bg-[#F5F5F2] overflow-y-auto" },
                    
                    // 1. ç¸½è¦½
                    tab === 'overview' && React.createElement('div', { className: "space-y-4 animate-zoom-in" },
                        React.createElement('div', { className: "text-white p-6 rounded-3xl shadow-lg text-center relative overflow-hidden", style: { background: `linear-gradient(135deg, ${COLORS.primary}, ${COLORS.primaryDark})` } }, 
                            React.createElement('p', { className: "text-sm opacity-80 mb-1" }, "æœ¬æ¬¡è¡Œç¨‹ç¸½èŠ±è²»"), 
                            React.createElement('h2', { className: "text-4xl font-bold tracking-tight" }, formatMoney(stats.total)),
                            React.createElement(Activity, { className: "absolute -right-4 -bottom-4 text-white opacity-10 w-32 h-32" })
                        ),
                        React.createElement('div', { className: "bg-white p-5 rounded-3xl shadow-sm border border-stone-100" },
                             React.createElement('h3', { className: "font-bold text-stone-700 mb-4 flex items-center gap-2" }, React.createElement(PieChart, { size: 18 }), "é¡žåˆ¥åˆ†æž"),
                             React.createElement('div', { className: "h-64" },
                                React.createElement(ResponsiveContainer, null, React.createElement(RePieChart, null, React.createElement(Pie, { data: stats.charts, dataKey: "value", cx: "50%", cy: "50%", innerRadius: 60, outerRadius: 80, paddingAngle: 5 }, stats.charts.map((e,i)=>React.createElement(Cell, { key: i, fill: e.color }))), React.createElement(ReTooltip), React.createElement(Legend)))
                             )
                        )
                    ),

                    // 2. æ˜Žç´°
                    tab === 'list' && React.createElement('div', { className: "space-y-3 animate-zoom-in" },
                        expenses.length === 0 ? React.createElement('div', { className: "text-center py-20 text-stone-400" }, "å°šç„¡æ¶ˆè²»ï¼Œè¨˜ä¸€ç­†å§ï¼") :
                        expenses.map(e => React.createElement('div', { key: e.id, className: "bg-white p-4 rounded-2xl shadow-sm border border-stone-100 flex justify-between items-center" },
                            React.createElement('div', { className: "flex items-center gap-4" },
                                React.createElement('div', { className: "w-12 h-12 rounded-full flex items-center justify-center text-white shadow-sm shrink-0", style: { backgroundColor: CATEGORIES.find(c=>c.id===e.category_id)?.color } }, e.title[0]),
                                React.createElement('div', null, 
                                    React.createElement('div', { className: "font-bold text-stone-800 text-lg" }, e.title), 
                                    React.createElement('div', { className: "text-xs text-stone-500 mt-0.5" }, project.members.find(m=>m.id===e.payer_id)?.name, " å…ˆä»˜")
                                )
                            ),
                            React.createElement('div', { className: "text-right" }, 
                                React.createElement('div', { className: "font-bold text-stone-800 text-lg" }, formatMoney(e.amount)),
                                React.createElement('button', { onClick: () => handleDelete(e.id), className: "text-xs text-red-400 mt-1 opacity-60 hover:opacity-100" }, "åˆªé™¤")
                            )
                        ))
                    ),

                    // 3. äººå“¡ (å«é¤˜é¡)
                    tab === 'members' && React.createElement('div', { className: "space-y-3 animate-zoom-in" },
                        project.members.map(m => React.createElement('div', { key: m.id, className: "bg-white p-4 rounded-2xl shadow-sm border border-stone-100 flex justify-between items-center" },
                            React.createElement('div', { className: "flex items-center gap-3" },
                                React.createElement('div', { className: "w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-600 font-bold" }, m.name[0]),
                                React.createElement('span', { className: "font-bold text-stone-700" }, m.name)
                            ),
                            React.createElement('span', { className: `font-bold text-lg ${balances[m.id] >= 0 ? 'text-teal-600' : 'text-red-500'}` }, (balances[m.id] > 0 ? "+" : "") + formatMoney(balances[m.id]))
                        ))
                    ),

                    // 4. çµç®—
                    tab === 'settle' && React.createElement('div', { className: "space-y-4 animate-zoom-in" },
                        React.createElement('div', { className: "p-4 rounded-xl border bg-[#F0F4F2] border-[#D1DBD6]" },
                            React.createElement('h3', { className: "font-bold mb-1 text-[#4A6756] flex items-center gap-2" }, React.createElement(Activity, { size: 18 }), "æœ€ä½³åŒ–å»ºè­°"),
                            React.createElement('p', { className: "text-xs text-[#6B8E78]" }, "ç³»çµ±å·²è‡ªå‹•è¨ˆç®—æœ€çŸ­é‚„æ¬¾è·¯å¾‘")
                        ),
                        debts.length === 0 ? React.createElement('div', { className: "text-center py-10 bg-white rounded-2xl shadow-sm" }, "å¸³ç›®å·²çµæ¸… ðŸŽ‰") :
                        debts.map((d, i) => React.createElement('div', { key: i, className: "bg-white p-4 rounded-2xl shadow-sm border border-stone-100 flex items-center justify-between" },
                            React.createElement('div', { className: "flex items-center gap-3" },
                                React.createElement('span', { className: "font-bold text-stone-700" }, project.members.find(m=>m.id===d.from)?.name),
                                React.createElement(ArrowRight, { size: 16, className: "text-stone-300" }),
                                React.createElement('span', { className: "font-bold text-stone-700" }, project.members.find(m=>m.id===d.to)?.name)
                            ),
                            React.createElement('span', { className: "font-bold text-teal-700 text-lg" }, formatMoney(d.amt))
                        ))
                    ),

                    // 5. è¨­å®š
                    tab === 'settings' && React.createElement('div', { className: "space-y-6 animate-zoom-in" },
                         React.createElement('div', { className: "bg-white p-5 rounded-2xl shadow-sm border border-stone-100" },
                            React.createElement('h3', { className: "font-bold mb-4 text-stone-700 flex items-center gap-2" }, React.createElement(Edit2, { size: 16 }), "åŸºæœ¬è¨­å®š"),
                            React.createElement('div', { className: "space-y-4" },
                                React.createElement('div', null, 
                                    React.createElement('label', { className: "text-xs text-stone-500 font-medium mb-1 block" }, "è¡Œç¨‹åç¨±"),
                                    React.createElement('input', { className: "w-full border-b border-stone-200 py-2 outline-none text-stone-700 focus:border-teal-500 transition-colors", defaultValue: project.name, onBlur: (e) => onUpdateProject({ name: e.target.value }) })
                                ),
                                React.createElement('button', { onClick: () => {
                                    const url = window.location.href.split('?')[0] + '?pid=' + project.id;
                                    navigator.clipboard.writeText(url);
                                    showToast("é€£çµå·²è¤‡è£½");
                                }, className: "w-full py-3 bg-stone-50 hover:bg-stone-100 rounded-xl text-stone-600 text-sm font-medium flex justify-center items-center gap-2 transition-colors" }, React.createElement(Share2, { size: 16 }), "è¤‡è£½é‚€è«‹é€£çµ")
                            )
                         ),
                         React.createElement('div', { className: "bg-white p-5 rounded-2xl shadow-sm border border-stone-100" },
                            React.createElement('button', { onClick: onDeleteProject, className: "w-full py-3 text-red-500 text-sm font-bold hover:bg-red-50 rounded-xl transition-colors" }, "åˆªé™¤æ­¤è¡Œç¨‹ (ç„¡æ³•å¾©åŽŸ)")
                         )
                    )
                ),
                showAdd && React.createElement(ExpenseModal, { project, onClose: () => setShowAdd(false), onSubmit: handleAdd })
            );
        }

        function ExpenseModal({ project, onClose, onSubmit }) {
            const [data, setData] = useState({ title: '', amount: '', category_id: 'food', payer_id: project.members[0].id, split_type: 'equal', involved_ids: project.members.map(m=>m.id) });
            const [uploading, setUploading] = useState(false);

            const handleFile = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                setUploading(true);
                try {
                    const blob = await compressImage(file);
                    const name = `receipt_${Date.now()}.jpg`;
                    const { error } = await supabase.storage.from('receipts').upload(name, blob);
                    if(!error) {
                        const { data: { publicUrl } } = supabase.storage.from('receipts').getPublicUrl(name);
                        setData(p => ({ ...p, attachments: [{ type: 'image', url: publicUrl }] }));
                    }
                } catch(err) { console.error(err); alert("ä¸Šå‚³å¤±æ•—"); }
                setUploading(false);
            };

            return React.createElement('div', { className: "fixed inset-0 bg-black/60 z-50 flex items-end md:items-center justify-center p-4 backdrop-blur-sm" },
                React.createElement('div', { className: "bg-white w-full max-w-sm rounded-3xl p-6 animate-zoom-in max-h-[90vh] overflow-y-auto" },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('h2', { className: "text-xl font-bold text-stone-800" }, "è¨˜ä¸€ç­†"),
                        React.createElement('button', { onClick: onClose }, React.createElement(X, { className: "text-stone-400" }))
                    ),
                    React.createElement('div', { className: "space-y-5" },
                        React.createElement('div', { className: "flex gap-3" },
                            React.createElement('input', { className: "flex-1 border-b-2 border-stone-200 p-2 text-lg outline-none focus:border-[#6B8E78] bg-transparent", placeholder: "é …ç›®åç¨±", value: data.title, onChange: e=>setData({...data, title: e.target.value}) }),
                            React.createElement('input', { className: "w-1/3 border-b-2 border-stone-200 p-2 text-lg outline-none focus:border-[#6B8E78] bg-transparent text-right font-mono", type: "number", placeholder: "$", value: data.amount, onChange: e=>setData({...data, amount: Number(e.target.value)}) })
                        ),
                        React.createElement('div', null, 
                            React.createElement('label', { className: "block text-xs font-medium text-stone-500 mb-2" }, "åˆ†é¡ž"),
                            React.createElement('div', { className: "flex gap-2 overflow-x-auto pb-2" }, CATEGORIES.map(c => 
                                React.createElement('button', { key: c.id, onClick: ()=>setData({...data, category_id: c.id}), className: `flex flex-col items-center p-2 rounded-xl border min-w-[60px] transition-all ${data.category_id===c.id ? 'bg-teal-50 border-teal-200 text-teal-700' : 'border-transparent bg-stone-50 text-stone-400'}` }, 
                                    React.createElement('div', { className: "w-8 h-8 rounded-full flex items-center justify-center mb-1 text-white", style: { backgroundColor: c.color } }, c.name[0]),
                                    React.createElement('span', { className: "text-xs" }, c.name)
                                )
                            ))
                        ),
                        React.createElement('div', null, 
                            React.createElement('label', { className: "block text-xs font-medium text-stone-500 mb-2" }, "å…ˆä»˜è€…"), 
                            React.createElement('select', { className: "w-full border border-stone-200 p-2.5 rounded-xl text-sm outline-none bg-stone-50", value: data.payer_id, onChange: e=>setData({...data, payer_id: e.target.value}) }, project.members.map(m => React.createElement('option', { key: m.id, value: m.id }, m.name)))
                        ),
                        React.createElement('div', null, 
                            React.createElement('label', { className: "block text-xs font-medium text-stone-500 mb-2" }, "æ”¶æ“šç…§ç‰‡"),
                            React.createElement('label', { className: "border border-dashed border-stone-300 bg-stone-50 p-3 rounded-xl flex justify-center items-center gap-2 cursor-pointer text-stone-500 text-sm hover:bg-stone-100 transition-colors" },
                                uploading ? React.createElement(RefreshCw, { size: 16, className: "animate-spin" }) : React.createElement(Camera, { size: 16 }),
                                data.attachments ? "å·²ä¸Šå‚³ (é»žæ“Šæ›´æ›)" : "ä¸Šå‚³åœ–ç‰‡",
                                React.createElement('input', { type: "file", className: "hidden", onChange: handleFile, accept: "image/*" })
                            )
                        ),
                        React.createElement('div', { className: "flex justify-end gap-2 mt-4 pt-4 border-t border-stone-100" },
                            React.createElement('button', { onClick: onClose, className: "px-5 py-2.5 text-stone-500 font-medium hover:bg-stone-50 rounded-xl" }, "å–æ¶ˆ"),
                            React.createElement('button', { onClick: () => { onSubmit(data); onClose(); }, className: "px-6 py-2.5 bg-[#6B8E78] text-white rounded-xl font-bold shadow-md hover:bg-[#5A7A66]" }, "å„²å­˜")
                        )
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
